---

- name: "sync icinga state to slaves"
  hosts: "cluster-admin"
  tasks:

    - name: "shut down icinga"
      action:
        module: "service"
        name: "icinga2"
        state: "stopped"
      sudo: "yes"

    - name: "fetch state from master"
      action:
        module: "fetch"
        src: "/var/lib/icinga2/icinga2.state"
        dest: "{{ deployment_home }}/work/{{ cluster }}/icinga-state"
        flat: "yes"
      sudo: "yes"
      when: "inventory_hostname == 'cluster-admin-a'"

    - name: "send state to slaves"
      action:
        module: "copy"
        src: "{{ deployment_home }}/work/{{ cluster }}/icinga-state"
        dest: "/var/lib/icinga2/icinga2.state"
        owner: "nagios"
        group: "nagios"
        mode: "0644"
      sudo: "yes"
      when: "inventory_hostname != 'cluster-admin-a'"

    - name: "delete zones config dir"
      action:
        module: "file"
        path: "/etc/icinga2/zones.d"
        state: "absent"
      sudo: "yes"
      when: "cluster != 'ops' or zon != 'a'"

    - name: "recreate zones config dir"
      action:
        module: "file"
        path: "/etc/icinga2/zones.d"
        state: "directory"
      sudo: "yes"
      when: "cluster != 'ops' or zon != 'a'"

    - name: "delete lib dirs"
      action:
        module: "file"
        path: "/var/lib/icinga2/api/{{ item }}"
        state: "absent"
      sudo: "yes"
      with_items:
        - "log"
        - "repository"
        - "zones"

    - name: "recreate lib dirs"
      action:
        module: "file"
        path: "/var/lib/icinga2/api/{{ item }}"
        state: "directory"
        owner: "nagios"
        group: "nagios"
        mode: "0750"
      sudo: "yes"
      with_items:
        - "log"
        - "repository"
        - "zones"

    - name: "delete logs"
      action:
        module: "file"
        path: "/var/log/icinga2/{{ item }}"
        state: "absent"
      sudo: "yes"
      with_items:
        - "debug.log"
        - "icinga2.err"
        - "icinga2.log"
        - "notice.log"
        - "startup.log"

    - name: "delete cache"
      action:
        module: "file"
        path: "/var/cache/icinga2/{{ item }}"
        state: "absent"
      sudo: "yes"
      with_items:
        - "icinga2.debug"
        - "icinga2.vars"
        - "objects.cache"
        - "status.dat"

    - name: "start icinga"
      action:
        module: "service"
        name: "icinga2"
        state: "started"
      sudo: "yes"

# ex: et ts=2 filetype=yaml
