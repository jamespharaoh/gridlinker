set -e

REMOVE_PACKAGES=(
)

INSTALL_PACKAGES=(
	"python-dev"
	"python-pip"

	"python-httplib2"
	"python-jinja2"
	"python-paramiko"
	"python-yaml"
)

PYTHON_PACKAGES=(
#	"paramiko"
#	"PyYAML"
#	"jinja2"
#	"httplib2"
)

if test -f /etc/ansible-flag; then

	echo "=== skipping first time setup for ansible" >&2
	echo "remove /etc/ansible-flag to run this again" >&2

else

	export DEBIAN_FRONTEND=noninteractive

	echo "=== running first time setup for ansible" >&2

	#echo "set grub-pc/install_devices /dev/sda" | debconf-communicate

	mirror=$(
		gawk -- "
			BEGIN { mirror = \"http://archive.ubuntu.com/ubuntu\" }
			match (\$0, /^ubuntu_url: \"([^\"]+)\"$/, ary) { mirror = ary [1] }
			END { print mirror }
		" < /vagrant/config
	)

	sed "s|{{ ubuntu_url }}|$mirror|" \
		</vagrant/roles/vagrant/templates/apt-sources-list \
		>/etc/apt/sources.list

	apt-get update -qqy

	apt-get purge -qqy "${REMOVE_PACKAGES[@]}"

	apt-get dist-upgrade -qqy

	apt-get install -qqy "${INSTALL_PACKAGES[@]}"

	#pip install "${PYTHON_PACKAGES[@]}"

	touch /etc/ansible-flag

fi

# ex: noet ts=4 filetype=sh
