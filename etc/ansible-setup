set -e

REMOVE_PACKAGES=(
)

INSTALL_PACKAGES=(
	"python-dev"
	"python-pip"

	"python-httplib2"
	"python-jinja2"
	"python-paramiko"
	"python-yaml"
)

PYTHON_PACKAGES=(
#	"paramiko"
#	"PyYAML"
#	"jinja2"
#	"httplib2"
)

if test -f /etc/ansible-flag; then

	echo "=== skipping first time setup for ansible" >&2
	echo "remove /etc/ansible-flag to run this again" >&2

else

	export DEBIAN_FRONTEND=noninteractive

	echo "=== running first time setup for ansible" >&2

	#echo "set grub-pc/install_devices /dev/sda" | debconf-communicate

	ubuntu_main_url=$(
		gawk -- "
			BEGIN { url = \"http://archive.ubuntu.com/ubuntu\" }
			match (\$0, /^ubuntu_main_url: \"([^\"]+)\"$/, ary) { url = ary [1] }
			END { print url }
		" < /vagrant/config
	)

	ubuntu_security_url=$(
		gawk -- "
			BEGIN { url = \"http://security.ubuntu.com/ubuntu\" }
			match (\$0, /^ubuntu_security_url: \"([^\"]+)\"$/, ary) { url = ary [1] }
			END { print url }
		" < /vagrant/config
	)

	echo "Using ubuntu main: $ubuntu_main_url" >&2
	echo "Using ubuntu security: $ubuntu_security_url" >&2

	sed "
		s|{{ ubuntu_main_url }}|$ubuntu_main_url|
		s|{{ ubuntu_security_url }}|$ubuntu_security_url|
	" \
		</vagrant/roles/vagrant/templates/apt-sources-list \
		>/etc/apt/sources.list

	apt-get update -qqy

	apt-get purge -qqy "${REMOVE_PACKAGES[@]}"

	apt-get dist-upgrade -qqy

	apt-get install -qqy "${INSTALL_PACKAGES[@]}"

	#pip install "${PYTHON_PACKAGES[@]}"

	rsync --archive \
		/vagrant/ \
		/home/vagrant/wistla-devops/

	touch /etc/ansible-flag

fi

# ex: noet ts=4 filetype=sh
