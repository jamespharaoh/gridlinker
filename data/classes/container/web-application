---

identity:

  name: "web-application"
  type: "class"

class:

  namespace: "host"
  parent_namespace: "host"

  groups:

    - "containers"
    - "{{ identity_cluster }}-web-application"
    - "{{ identity_cluster }}-{{ identity_index }}"

  references:

    - name: "cluster"
      type: "resource"
      value: "cluster/{{ identity_cluster }}"
      section: "cluster"

container:

  type: "web-application"
  directory: "/datingnode-{{ identity_cluster }}/{{ identity_name }}"

start:

  name: "{{ identity_name }}"
  registry: "{{ docker_registry }}"
  image: "{{ docker_images.web_application }}:{{ cluster.build.web_application }}"

  expose:
    - "80"

  ports:
    - "{{ parent.private.address }}:{{ cluster.ports.web_application }}:80"

  volumes_default:
    - "{{ container_directory }}/config:/config"
    - "{{ container_directory }}/data:/data"

  volumes_instant:
    - "{{ devbox_home }}/datingnode-super:/var/www/datingnode-super"

  volumes_all: "{{ start_volumes_default + start_volumes_instant }}"

  volumes: "{{
    start_volumes_all
    if instant_deploy == 'yes'
    and parent.identity_class == 'vagrant-devbox'
    else start_volumes_default
  }}"

  env: {}

  wait:
    - "{{ cluster.ports.web_application }}"

  reload_commands:
    - "/etc/my_init.d/ansible"
    - "sv hup php-fpm"
    - "sv hup apache"

system:

  init: "upstart"

ubuntu:

  release: "trusty"

# ex: et ts=2 filetype=yaml
