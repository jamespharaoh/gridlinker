set -e

REMOVE_PACKAGES=(
)

INSTALL_PACKAGES=(

	"git"

	"python-dev"
	"python-pip"

	"python-httplib2"
	"python-jinja2"
	"python-paramiko"
	"python-yaml"

)

PYTHON_PACKAGES=(
#	"paramiko"
#	"PyYAML"
#	"jinja2"
#	"httplib2"
)

if test -f /etc/ansible-flag; then

	echo "=== skipping first time setup for ansible" >&2
	echo "remove /etc/ansible-flag to run this again" >&2

else

	export DEBIAN_FRONTEND=noninteractive

	echo "=== running first time setup for ansible" >&2

	#echo "set grub-pc/install_devices /dev/sda" | debconf-communicate

	ubuntu_main_url=$(
		gawk -- "
			BEGIN { url = \"http://archive.ubuntu.com/ubuntu\" }
			match (\$0, /^ubuntu_main_url: \"([^\"]+)\"$/, ary) { url = ary [1] }
			END { print url }
		" < /vagrant/config
	)

	ubuntu_security_url=$(
		gawk -- "
			BEGIN { url = \"http://security.ubuntu.com/ubuntu\" }
			match (\$0, /^ubuntu_security_url: \"([^\"]+)\"$/, ary) { url = ary [1] }
			END { print url }
		" < /vagrant/config
	)

	echo "Using ubuntu main: $ubuntu_main_url" >&2
	echo "Using ubuntu security: $ubuntu_security_url" >&2

	sed "
		s|{{ ubuntu_main_url }}|$ubuntu_main_url|
		s|{{ ubuntu_security_url }}|$ubuntu_security_url|
	" \
		</vagrant/apt-sources-list \
		>/etc/apt/sources.list

	apt-get update -qqy

	apt-get purge -qqy "${REMOVE_PACKAGES[@]}"

	apt-get dist-upgrade -qqy

	apt-get install -qqy "${INSTALL_PACKAGES[@]}"

	#pip install "${PYTHON_PACKAGES[@]}"

	cd /home/vagrant

	(
		echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=="
	) >/etc/ssh/ssh_known_hosts

	touch /etc/ansible-flag

fi

# ex: noet ts=4 filetype=sh
