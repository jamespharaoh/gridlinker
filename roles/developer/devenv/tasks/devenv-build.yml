---

- name: "run build steps"
  when: "deployment_mode == 'vagrant'"
  with_items: "{{ devenv_checkouts | map (attribute = 'name') | list }}"
  args:

    executable: "/bin/bash"
    chdir: "{{ deployment_home }}/{{ item.name }}"

  shell: "{{ [
    'set -euf -o pipefail;',
    [
      'mkdir -p ',
      WORK,
      '/build-logs',
    ],
    [
      [
        '(set -x; ',
        devenv_checkouts
          | selectattr ('name', 'equalto', item)
          | map (attribute = 'build_steps')
          | first
          | default (['true'])
          | join (' && '),
        ' )',
      ] | join,
      [
        'tee ',
        WORK,
        '/build-logs/',
        item,
        '.log',
      ] | join,
    ] | join (' | '),
  ] | join (' ') }}"

- name: "run build steps"
  when: "deployment_mode == 'jenkins'"
  with_items: "{{ devenv_checkouts | map (attribute = 'name') | list }}"
  args:

    executable: "/bin/bash"
    chdir: "{{ deployment_home }}/{{ item.name }}"

  shell: "{{ [
    'set -euf -o pipefail;',
    [
      'mkdir ',
      lookup ('env', 'WORKSPACE'),
      '/wistla-devops/build-logs',
    ],
    [
      [
        'ssh 10.190.0.2 ',
        'set -x \\; cd ',
        lookup ('env', 'WORKSPACE'),
        '/',
        item.name,
        \" '&&' \",
        devenv_checkouts
          | selectattr ('name', 'equalto', item)
          | map (attribute = 'build_steps')
          | first
          | default (['true'])
          | join (\" '&&' \"),
      ] | join,
      [
        'tee ',
        lookup ('env', 'WORKSPACE'),
        '/wistla-devops/work/build-logs/',
        item,
        '.log',
      ] | join,
    ] | join (' | '),
  ] | join }}"

# ex: et ts=2 filetype=yaml
