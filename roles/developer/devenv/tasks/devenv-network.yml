---

- name: "create bridge network interface"
  register: "devenv_bridge_create_result"
  become: "yes"
  action:

    module: "template"
    src: "devenv-bridge-interface"
    dest: "/etc/network/interfaces.d/{{ deployment.bridge_name }}.cfg"

- name: "stop network bridge"
  when: "devenv_bridge_create_result | changed"
  register: "devenv_bridge_stop_result"
  changed_when: "devenv_bridge_stop_result.stdout != 'UNCHANGED'"
  become: "yes"
  args:

    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    if ! ifquery --state {{ deployment.bridge_name }} >/dev/null; then
      echo "UNCHANGED";
      exit;
    fi

    ifdown {{ deployment.bridge_name }};

- name: "start network bridge"
  register: "devenv_bridge_start_result"
  changed_when: "devenv_bridge_start_result.stdout != 'UNCHANGED'"
  become: "yes"
  args:

    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    if ifquery --state {{ deployment.bridge_name }} >/dev/null; then
      echo "UNCHANGED";
      exit;
    fi

    ifup {{ deployment.bridge_name }};

# ex: et ts=2 filetype=yaml
