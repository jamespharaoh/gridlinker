---

- name: "enable rabbit management plugin"
  args:
    creates: "{{ deployment_home }}/shared/flags/rabbit-management-plugin"
  shell: "{{ [
    [
      deployment_name + '-rabbit-' + fixtures_host_suffix,
      'sudo',
      'rabbitmq-plugins',
      'enable',
      'rabbitmq_management',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/rabbit-management-plugin',
  ] | join (' && ') }}"

- name: "create rabbit api user"
  args:
    creates: "{{ deployment_home }}/shared/flags/rabbit-api-user"
  shell: "{{ [
    [
      '(',
      deployment_name + '-rabbit-' + fixtures_host_suffix,
      'sudo',
      'rabbitmqctl',
      'add_user',
      'api',
      deployment.rabbit_api_password,
      ') || true',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/rabbit-api-user',
  ] | join (' && ') }}"

- name: "set rabbit api user tags"
  args:
    creates: "{{ deployment_home }}/shared/flags/rabbit-api-user-tags"
  shell: "{{ [
    [
      deployment_name + '-rabbit-' + fixtures_host_suffix,
      'sudo',
      'rabbitmqctl',
      'set_user_tags',
      'api',
      'management',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/rabbit-api-user-tags',
  ] | join (' && ') }}"

- name: "set rabbit api user permissions"
  args:
    creates: "{{ deployment_home }}/shared/flags/rabbit-api-user-permissions"
  shell: "{{ [
    [
      deployment_name + '-rabbit-' + fixtures_host_suffix,
      'sudo',
      'rabbitmqctl',
      'set_permissions',
      'api',
      '.\\*',
      '.\\*',
      '.\\*',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/rabbit-api-user-permissions',
  ] | join (' && ') }}"

- name: "create rabbit admin user"
  args:
    creates: "{{ deployment_home }}/shared/flags/rabbit-admin-user"
  shell: "{{ [
    [
      '(',
      deployment_name + '-rabbit-' + fixtures_host_suffix,
      'sudo',
      'rabbitmqctl',
      'add_user',
      'admin',
      deployment.rabbit_admin_password,
      ') || true',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/rabbit-admin-user',
  ] | join (' && ') }}"

- name: "set rabbit admin user tags"
  args:
    creates: "{{ deployment_home }}/shared/flags/rabbit-admin-user-tags"
  shell: "{{ [
    [
      deployment_name + '-rabbit-' + fixtures_host_suffix,
      'sudo',
      'rabbitmqctl',
      'set_user_tags',
      'admin',
      'management',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/rabbit-admin-user-tags',
  ] | join (' && ') }}"

- name: "set rabbit admin user permissions"
  args:
    creates: "{{ deployment_home }}/shared/flags/rabbit-admin-user-permissions"
  shell: "{{ [
    [
      deployment_name + '-rabbit-' + fixtures_host_suffix,
      'sudo',
      'rabbitmqctl',
      'set_permissions',
      'admin',
      '.\\*',
      '.\\*',
      '.\\*',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/rabbit-admin-user-permissions',
  ] | join (' && ') }}"

- name: "join rabbit cluster"
  when: "instance_zone != 'a'"
  args:
    creates: "{{ deployment_home }}/shared/flags/rabbit-cluster"
  shell: "{{ [
    [
      deployment_name + '-rabbit-' + fixtures_host_suffix,
      'sudo',
      'rabbitmqctl',
      'stop_app',
    ] | join (' '),
    [
      deployment_name + '-rabbit-' + fixtures_host_suffix,
      'sudo',
      'rabbitmqctl',
      'join_cluster',
      'rabbit@' + deployment_name + '-rabbit-a-4',
    ] | join (' '),
    [
      deployment_name + '-rabbit-' + fixtures_host_suffix,
      'sudo',
      'rabbitmqctl',
      'start_app',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/rabbit-cluster',
  ] | join (' && ') }}"

# ex: et ts=2 filetype=yaml
