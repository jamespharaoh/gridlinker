---

- name: "create postgresql cache data"
  args:

    creates: "{{ deployment_home }}/shared/flags/postgresql-cache-data"

  shell: "{{ [
    'sleep 2',
    [
      deployment_name + '-postgresql-cache-' + fixtures_host_suffix,
      'sudo service postgresql stop || true',
    ] | join (' '),
    [
      deployment_name + '-postgresql-cache-' + fixtures_host_suffix,
      'sudo rm -rf /var/lib/postgresql/9.5/main',
    ] | join (' '),
    [
      deployment_name + '-postgresql-cache-' + fixtures_host_suffix,
      'sudo',
      '-H -u postgres',
      '/usr/lib/postgresql/9.5/bin/initdb',
      '--pgdata',
      '/var/lib/postgresql/9.5/main',
      '--encoding',
      'utf-8',
    ] | join (' '),
    [
      deployment_name + '-postgresql-cache-' + fixtures_host_suffix,
      'sudo service postgresql start',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/postgresql-cache-data',
  ] | join (' && ') }}"

- name: "create postgresql cache user ubuntu"
  args:

    creates: "{{ deployment_home }}/shared/flags/postgresql-cache-user-ubuntu"

  shell: "{{ [
    'sleep 2',
    [
      deployment_name + '-postgresql-cache-' + fixtures_host_suffix,
      'sudo',
      '-u postgres',
      'createuser',
      'ubuntu',
      '--superuser',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/postgresql-cache-user-ubuntu',
  ] | join (' && ') }}"

- name: "create postgresql cache user vagrant"
  args:

    creates: "{{ deployment_home }}/shared/flags/postgresql-cache-user-vagrant"

  shell: "{{ [
    'sleep 2',
    [
      deployment_name + '-postgresql-cache-' + fixtures_host_suffix,
      'sudo',
      '-u postgres',
      'createuser',
      'vagrant',
      '--superuser',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/postgresql-cache-user-vagrant',
  ] | join (' && ') }}"

- name: "create postgresql cache user wistla"
  args:

    creates: "{{ deployment_home }}/shared/flags/postgresql-cache-user-wistla"

  shell: "{{ [
    'sleep 2',
    [
      deployment_name + '-postgresql-cache-' + fixtures_host_suffix,
      'sudo',
      '-u postgres',
      'createuser',
      'wistla',
      '--superuser',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/postgresql-cache-user-wistla',
  ] | join (' && ') }}"

- name: "create postgresql cache user replicate"
  args:

    creates: "{{ deployment_home }}/shared/flags/postgresql-cache-user-replicate"

  shell: "{{ [
    'sleep 2',
    [
      deployment_name + '-postgresql-main-' + fixtures_host_suffix,
      'sudo',
      '-u postgres',
      'createuser',
      'replicate',
      '--replication',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/postgresql-cache-user-replicate',
  ] | join (' && ') }}"

- name: "create postgresql cache database wistla"
  args:

    creates: "{{ deployment_home }}/shared/flags/postgresql-cache-database-wistla"

  shell: "{{ [
    [
      deployment_name + '-postgresql-cache-' + fixtures_host_suffix,
      'sudo',
      '-u postgres',
      'createdb',
      'wistla',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/postgresql-cache-database-wistla',
  ] | join (' && ') }}"

- name: "create postgresql cache schema wistla"
  args:

    creates: "{{ deployment_home }}/shared/flags/postgresql-cache-schema-wistla"

  shell: "{{ [
    [
      deployment_name + '-postgresql-cache-' + fixtures_host_suffix,
      'sudo',
      '-u postgres',
      'psql',
      'wistla',
      '-c \"CREATE SCHEMA wistla;\"',
    ] | join (' '),
    'touch ' + deployment_home + '/shared/flags/postgresql-cache-schema-wistla',
  ] | join (' && ') }}"

# ex: et ts=2 filetype=yaml
