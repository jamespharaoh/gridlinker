---

- name: "install kernel"
  register: "devbox_install_kernel"
  become: "yes"
  action:

    module: "apt"
    name: "linux-generic-lts-wily"

- name: "warn about halt"
  when: "devbox_install_kernel | changed"
  pause:

    prompt: "{{ [
      'The virtual machine will now power off. This is necessary to upgrade',
      'the kernel. You will need to manually restart it using the \"vagrant',
      'up\" command, which will ensure that vagrant correctly initializes it.',
      'Once the machine has started up again, please run this operation again.',
      'Please press ENTER to continue.',
    ] | join (' ') }}"
    minutes: "999999"

- name: "halt after kernel upgrade"
  when: "devbox_install_kernel | changed"
  become: "yes"
  command: "halt --poweroff"

- name: "setup sudo"
  become: "yes"
  action:

    module: "template"
    dest: "/etc/sudoers.d/ssh-agent"
    src: "devbox-sudoers-ssh-agent"

- name: "install motd"
  args:

    executable: "/bin/bash"

  become: "yes"
  shell:

    set -euf -o pipefail;

    paste
      "{{ HOME }}/misc/deployment-icons/{{ deployment_name }}.xterm"
      "{{ HOME }}/misc/wistla-dark.xterm"
    | sed 's/\t//'
    > /etc/motd;

- name: "remove annoying motd elements"
  with_items:

    - "10-help-text"
    - "50-landscape-sysinfo"
    - "51-cloudguest"
    - "98-cloudguest"
    - "98-fsck-at-reboot"

  become: "yes"
  action:

    module: "file"
    path: "/etc/update-motd.d/{{ item }}"
    state: "absent"

# ex: et ts=2 filetype=yaml
