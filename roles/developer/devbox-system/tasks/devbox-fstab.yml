---

- name: "create btrfs disk"
  when: "devbox_lxc_device == '/btrfs-image'"
  args:

    creates: "/btrfs-image"

  become: "yes"
  command: "truncate --size 32GiB /btrfs-image"

- name: "create btrfs file system"
  when: "devbox_lxc_device == '/btrfs-image'"
  args:

    executable: "/bin/bash"
    creates: "/etc/btrfs-flag"

  become: "yes"
  shell:

    set -euf -o pipefail;

    mkfs.btrfs /btrfs-image;

    touch /etc/btrfs-flag;

- name: "create fstab"
  become: "yes"
  action:

    module: "template"
    dest: "/etc/fstab"
    src: "devbox-fstab"

- name: "mount all filesystems"
  register: "mount_result"
  changed_when: "mount_result.stdout != ''"
  become: "yes"
  command: "mount -a"

- name: "active swap partition"
  when: "devbox_swap_device != ''"
  register: "swapon_result"
  changed_when: "swapon_result.stdout != ''"
  become: "yes"
  command: "swapon -a"

# ex: et ts=2 filetype=yaml
