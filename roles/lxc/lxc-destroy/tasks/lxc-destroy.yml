---

- name: "remove bind mounts"
  when: "node_is_template == 'yes'"
  delegate_to: "localhost"
  become: "yes"
  args:

    executable: "/bin/bash"

  become: "yes"
  shell:

    set -euf -o pipefail;

    for mount in $(
      cat /proc/mounts
      | cut --delimiter ' ' --field 2
      | egrep '{{ node_rootfs_path }}/'
    ); do
      umount -f $mount;
    done;

- name: "destroy lxc container"
  register: destroy_result
  changed_when: destroy_result.stdout != 'UNCHANGED'
  delegate_to: "localhost"
  args:

    executable: "/bin/bash"

  become: "yes"
  shell:

    set -euf -o pipefail;

    source {{ deployment_home }}/wistla-devops/misc/locking ansible;
    exlock;

    if ! test -d /var/lib/lxc/{{ inventory_hostname }}; then
      echo "UNCHANGED";
      exit 0;
    fi;

    lxc-destroy
      --name {{ inventory_hostname }};

# ex: et ts=2 filetype=yaml
