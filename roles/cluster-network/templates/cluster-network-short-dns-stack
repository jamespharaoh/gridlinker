---

AWSTemplateFormatVersion: "2010-09-09"
Description: "Wistla short dns"

Resources:

  HostedZone:
    Type: "AWS::Route53::HostedZone"
    Properties:
      Name: "wist.la."

{% for deployment_alias_name, deployment_alias in deployment_aliases.items () %}

{% set other_cluster_data = lookup ('file', [
  '/home/vagrant/work/',
  deployment_alias.cluster,
  '/cluster-data',
] | join ('')) | from_yaml %}

  {{ deployment_alias.name | capitalize }}RecordSet:
    Type: "AWS::Route53::RecordSet"
    Properties:
      Name: "{{ deployment_alias.short_domain }}."
      Type: "A"
      AliasTarget:
        DNSName: "{{ other_cluster_data.cluster_app_balancer_hosted_zone_name }}"
        HostedZoneId: "{{ other_cluster_data.cluster_app_balancer_hosted_zone_name_id }}"
      HostedZoneId: { Ref: "HostedZone" }

{% endfor %}

{% for deployment_name, deployment in deployments.items () %}
{% if deployment.cluster == 'dev' %}

{% set other_cluster_data = lookup ('file', [
  '/home/vagrant/work/ops/cluster-data',
] | join ('')) | from_yaml %}

  {{ deployment_name | replace ('-', '') | capitalize }}RecordSet:
    Type: "AWS::Route53::RecordSet"
    Properties:
      Name: "{{ deployment.short_domain }}."
      Type: "A"
      AliasTarget:
        DNSName: "{{ other_cluster_data.cluster_admin_balancer_hosted_zone_name }}"
        HostedZoneId: "{{ other_cluster_data.cluster_admin_balancer_hosted_zone_name_id }}"
      HostedZoneId: { Ref: "HostedZone" }

{% else %}

{% set other_cluster_data = lookup ('file', [
  '/home/vagrant/work/',
  deployment.cluster,
  '/cluster-data',
] | join ('')) | from_yaml %}

  {{ deployment_name | replace ('-', '') | capitalize }}RecordSet:
    Type: "AWS::Route53::RecordSet"
    Properties:
      Name: "{{ deployment.short_domain }}."
      Type: "A"
      AliasTarget:
        DNSName: "{{ other_cluster_data.cluster_app_balancer_hosted_zone_name }}"
        HostedZoneId: "{{ other_cluster_data.cluster_app_balancer_hosted_zone_name_id }}"
      HostedZoneId: { Ref: "HostedZone" }

{% endif %}
{% endfor %}

Outputs:

  HostedZone:
    Value: { Ref: "HostedZone" }

# ex: et ts=2 filetype=yaml
