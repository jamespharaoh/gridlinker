---

- name: "write {{ subnet_name }} subnet stack yaml"
  action:

    module: "template"
    src: "cluster-network-subnet-stack"
    dest: "{{ deployment_home }}/work/{{ cluster_name }}/{{ subnet_name }}-subnet-stack.yaml"

- name: "create {{ subnet_name }} subnet stack"
  register: "subnet_stack_result"
  action:

    module: "cloudformation"
    stack_name: "{{ cluster_name }}-subnet-{{ subnet_name }}"
    state: "present"

    template: "{{ deployment_home }}/work/{{ cluster_name }}/{{ subnet_name }}-subnet-stack.yaml"
    template_format: "yaml"

    region: "{{ amazon_region_name }}"

    aws_access_key: "{{ amazon_credentials [amazon_account_name].access_key }}"
    aws_secret_key: "{{ amazon_credentials [amazon_account_name].secret_key }}"
    security_token: "{{ amazon_credentials [amazon_account_name].session_token }}"

- update_resource:

    "routes_{{ subnet_name }}_a": "{{ subnet_stack_result.stack_outputs.RouteTableA }}"
    "routes_{{ subnet_name }}_b": "{{ subnet_stack_result.stack_outputs.RouteTableB }}"
    "routes_{{ subnet_name }}_c": "{{ subnet_stack_result.stack_outputs.RouteTableC }}"
    "subnet_{{ subnet_name }}_a": "{{ subnet_stack_result.stack_outputs.SubnetA }}"
    "subnet_{{ subnet_name }}_b": "{{ subnet_stack_result.stack_outputs.SubnetB }}"
    "subnet_{{ subnet_name }}_c": "{{ subnet_stack_result.stack_outputs.SubnetC }}"

# ex: et ts=2 filetype=yaml
