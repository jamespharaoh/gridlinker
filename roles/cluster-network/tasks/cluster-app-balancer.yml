---

- name: "create app balancer"
  action:
    module: "ec2_elb_lb"

    name: "{{ cluster_name }}-app"
    state: "present"

    listeners:

      - protocol: "tcp"
        load_balancer_port: "80"
        instance_port: "80"

      - protocol: "tcp"
        load_balancer_port: "443"
        instance_port: "443"

    security_group_ids: "{{ cluster_dynamic.cluster_group_balancer }}"

    subnets:
      - "{{ cluster_dynamic.cluster_subnet_admin_a }}"
      - "{{ cluster_dynamic.cluster_subnet_admin_b }}"
      - "{{ cluster_dynamic.cluster_subnet_admin_c }}"

    health_check:
      ping_protocol: "tcp"
      ping_port: "80"
      response_timeout: "2"
      interval: "10"
      unhealthy_threshold: "2"
      healthy_threshold: "4"

    region: "{{ amazon_region }}"
    aws_access_key: "{{ amazon_accounts [amazon_account].access_key }}"
    aws_secret_key: "{{ amazon_accounts [amazon_account].secret_key }}"

  register: "app_balancer_result"

- set_fact:

    cluster_app_balancer: "{{ app_balancer_result.elb.dns_name }}"
    cluster_app_balancer_hosted_zone_name: "{{ app_balancer_result.elb.canonical_hosted_zone_name }}"
    cluster_app_balancer_hosted_zone_name_id: "{{ app_balancer_result.elb.canonical_hosted_zone_name_id }}"

- include: "cluster-save-data.yml"

# ex: et ts=2 filetype=yaml
