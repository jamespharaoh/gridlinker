---

- name: "create icinga balancer"
  action:
    module: "ec2_elb_lb"

    name: "{{ cluster }}-icinga"
    state: "present"

    listeners:

      - protocol: "http"
        load_balancer_port: "80"
        instance_port: "80"

      - protocol: "https"
        load_balancer_port: "443"
        instance_protocol: "http"
        instance_port: "80"
        ssl_certificate_id: "arn:aws:iam::382254491475:server-certificate/icinga.ops.wistla.com"

    security_group_ids: "{{ cluster_group_balancer }}"

    subnets:

      - "{{ cluster_subnet_admin_a }}"
      - "{{ cluster_subnet_admin_b }}"
      - "{{ cluster_subnet_admin_c }}"

    region: "{{ amazon_region }}"
    aws_access_key: "{{ amazon_accounts [amazon_account].access_key }}"
    aws_secret_key: "{{ amazon_accounts [amazon_account].secret_key }}"

  register: "icinga_balancer_result"

- set_fact:
    cluster_balancer_icinga: "{{ icinga_balancer_result.elb.dns_name }}"

- include: "cluster-save-data.yml"

- name: "create icinga dns"
  action:
    module: "route53"
    command: "create"
    overwrite: "yes"

    zone: "{{ cluster_domain }}"
    record: "icinga.{{ cluster_domain }}"
    ttl: "60"
    type: "CNAME"
    value: "{{ cluster_balancer_icinga }}"

    aws_access_key: "{{ amazon_accounts [amazon_account].access_key }}"
    aws_secret_key: "{{ amazon_accounts [amazon_account].secret_key }}"

# ex: et ts=2 filetype=yaml
