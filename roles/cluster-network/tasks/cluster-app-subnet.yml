---

- set_fact:
    subnet: "app"

- name: "write app subnet stack yaml"
  action:
    module: "template"
    src: "cluster-subnet-stack"
    dest: "/home/vagrant/work/{{ cluster_name }}/app-subnet-stack.yaml"
  sudo: "yes"
  sudo_user: "vagrant"

- name: "create app subnet stack"
  action:
    module: "cloudformation"
    stack_name: "{{ cluster_name }}-subnet-app"
    state: "present"
    template: "/home/vagrant/work/{{ cluster_name }}/app-subnet-stack.yaml"
    template_format: "yaml"
    aws_access_key: "{{ amazon_accounts [amazon_account].access_key }}"
    aws_secret_key: "{{ amazon_accounts [amazon_account].secret_key }}"
    region: "{{ amazon_region }}"
  sudo: "yes"
  sudo_user: "vagrant"
  register: "app_subnet_stack_result"

- set_fact:
    cluster_routes_app_a: "{{ app_subnet_stack_result.stack_outputs.RouteTableA }}"
    cluster_routes_app_b: "{{ app_subnet_stack_result.stack_outputs.RouteTableB }}"
    cluster_routes_app_c: "{{ app_subnet_stack_result.stack_outputs.RouteTableC }}"
    cluster_subnet_app_a: "{{ app_subnet_stack_result.stack_outputs.SubnetA }}"
    cluster_subnet_app_b: "{{ app_subnet_stack_result.stack_outputs.SubnetB }}"
    cluster_subnet_app_c: "{{ app_subnet_stack_result.stack_outputs.SubnetC }}"

- include: "cluster-save-data.yml"

# ex: et ts=2 filetype=yaml
