---

- name: "install system packages"
  action:
    module: "apt"
    state: "present"
    name: "{{ item }}"
  sudo: "yes"
  sudo_user: "root"
  with_items: "devbox_install_packages"
  tags: "update"

- name: "remove system packages"
  action:
    module: "apt"
    state: "removed"
    purge: "yes"
    name: "{{ item }}"
  sudo: "yes"
  sudo_user: "root"
  with_items: "devbox_remove_packages"
  tags: "update"

- name: "setup sudo"
  action:
    module: "template"
    src: "devbox-sudoers-ssh-agent"
    dest: "/etc/sudoers.d/ssh-agent"
  sudo: "yes"
  sudo_user: "root"

- name: "install ssh known hosts"
  action:
    module: "template"
    src: "devbox-ssh-known-hosts"
    dest: "/etc/ssh/ssh_known_hosts"
  sudo: "yes"
  sudo_user: "root"

- name: "install python packages"
  action:
    module: "pip"
    name: "{{ item }}"
  sudo: "yes"
  with_items: "devbox_install_python"

- name: "install ruby packages"
  action:
    module: "gem"
    name: "{{ item }}"
  with_items: "devbox_install_ruby"

- name: "get info about second disk"
  action:
    module: "stat"
    path: "/dev/sdb"
  register: "sdb_result"

- name: "check second disk is present"
  action:
    module: "fail"
    msg: "please add second drive to virtual machine"
  when: "not sdb_result.stat.exists"

- name: "setup second disk"
  shell:
    set -e;
    parted /dev/sdb --script --align none -- mklabel gpt;
    parted /dev/sdb --script --align none -- unit mb mkpart primary ext4 0 -0;
    mkfs.ext4 /dev/sdb1;
    mkdir -p /datingnode-local;
    echo '/dev/sdb1 /datingnode-local ext4 defaults 0 0' >>/etc/fstab;
    mount /datingnode-local;
    touch /datingnode-local/.setup-flag;
    true;
  args:
    creates: "/datingnode-local/.setup-flag"
  sudo: "yes"

# ex: et ts=2 filetype=yaml
