---

- name: "checkout projects from git"
  shell:

    set -e;

    cd {{ vagrant_home }};

    git clone
      git@github.com:/wistla/{{ item.name }}
      --branch {{ item.branch }};

  args:
    creates: "{{ vagrant_home }}/{{ item.name }}"
  sudo: "yes"
  sudo_user: "{{ vagrant_user }}"
  with_items: "vagrant_checkouts"

- name: "install node modules"
  shell:

    set -e;

    cd {{ vagrant_home }}/{{ item }};

    npm install;

  args:
    creates: "{{ vagrant_home }}/{{ item }}/node_modules"
  sudo: "yes"
  sudo_user: "{{ vagrant_user }}"
  with_items:
    - "wistla-web"

- name: "create git pre-commit hooks"
  action:
    module: "template"
    src: "git-hook-pre-commit"
    dest: "{{ vagrant_home }}/{{ item.name }}/.git/hooks/pre-commit"
    mode: "0755"
  sudo: "yes"
  sudo_user: "{{ vagrant_user }}"
  with_items: "vagrant_checkouts"

- name: "create git post-checkout hooks"
  action:
    module: "template"
    src: "git-hook-post-checkout"
    dest: "{{ vagrant_home }}/{{ item.name }}/.git/hooks/post-checkout"
    mode: "0755"
  sudo: "yes"
  sudo_user: "{{ vagrant_user }}"
  with_items: "vagrant_checkouts"

- name: "create shared directory"
  action:
    module: "file"
    path: "{{ vagrant_home }}/shared"
    state: "directory"
  sudo: "yes"
  sudo_user: "{{ vagrant_user }}"

- name: "create config directories"
  action:
    module: "file"
    path: "{{ item }}"
    state: "directory"
  sudo: "yes"
  sudo_user: "{{ vagrant_user }}"
  with_items:
    - "{{ vagrant_home }}/config"
    - "{{ vagrant_home }}/config/api"
    - "{{ vagrant_home }}/config/load"
    - "{{ vagrant_home }}/config/mongo"
    - "{{ vagrant_home }}/config/web"

- name: "create config files"
  action:
    module: "template"
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  sudo: "yes"
  sudo_user: "{{ vagrant_user }}"
  with_items:

    - src: "devbox-wistla-api-config"
      dest: "{{ vagrant_home }}/config/api/config.local.js"

    - src: "devbox-wistla-web-config"
      dest: "{{ vagrant_home }}/config/web/config.local.js"

- name: "create links to config files"
  action:
    module: "file"
    path: "{{ item.dest }}"
    src: "{{ item.src }}"
    state: "link"
    force: "yes"
  sudo: "yes"
  sudo_user: "{{ vagrant_user }}"
  with_items:

    - src: "../../config/api/config.local.js"
      dest: "{{ vagrant_home }}/wistla-api/config/config.local.js"

    - src: "../../config/web/config.local.js"
      dest: "{{ vagrant_home }}/wistla-web/config/config.local.js"

# ex: et ts=2 filetype=yaml
