---

- set_fact:

    kernel_version_combo: "{{ kernel_version }}-{{ kernel_version_zero }}"
    kernel_base_url: "{{ kernel_mirror }}/v{{ kernel_version }}-{{ kernel_branch }}"

- set_fact:

    kernel_a_file: "{{ [
      'linux-headers-' + kernel_version_combo + '-' + kernel_type,
      kernel_version_combo + '.' + kernel_build,
      kernel_arch + '.deb',
    ] | join ('_') }}"

    kernel_b_file: "{{ [
      'linux-headers-' + kernel_version_combo,
      kernel_version_combo + '.' + kernel_build,
      'all.deb',
    ] | join ('_') }}"

    kernel_c_file: "{{ [
      'linux-image-' + kernel_version_combo + '-' + kernel_type,
      kernel_version_combo + '.' + kernel_build,
      kernel_arch + '.deb',
    ] | join ('_') }}"

- set_fact:

    kernel_a_url: "{{ kernel_base_url }}/{{ kernel_a_file }}"
    kernel_b_url: "{{ kernel_base_url }}/{{ kernel_b_file }}"
    kernel_c_url: "{{ kernel_base_url }}/{{ kernel_c_file }}"

- name: "install kernel"
  shell:

    set -e;

    rm -rf /tmp/kernel;
    mkdir /tmp/kernel;
    cd /tmp/kernel;

    wget --progress=dot "{{ kernel_a_url }}";
    wget --progress=dot "{{ kernel_b_url }}";
    wget --progress=dot "{{ kernel_c_url }}";

    dpkg --install
    "{{ kernel_a_file }}"
    "{{ kernel_b_file }}"
    "{{ kernel_c_file }}";

    touch /etc/kernel-{{ kernel_version }};

  args:
    executable: "/bin/bash"
    creates: "/etc/kernel-{{ kernel_version }}"
  sudo: "yes"
  register: "install_kernel_result"

- name: "reboot"
  command: "shutdown -r now"
  async: "0"
  poll: "0"
  ignore_errors: "true"
  when: "install_kernel_result.changed"
  sudo: "yes"
  tags: "reboot"

- name: "waiting for server to reboot"
  connection: "local"
  action:
    module: "wait_for"
    host: "{{ ansible_ssh_host }}"
    state: "started"
    port: "22"
    delay: "10"
  when: "install_kernel_result.changed"
  tags: "reboot"

# ex: et ts=2 filetype=yaml
