---

- name: "install system packages"
  action:
    module: "apt"
    state: "present"
    name: "{{ item }}"
  sudo: "yes"
  with_items: "api_install_packages"

- name: "make node command work"
  action:
    module: "alternatives"
    link: "/usr/bin/node"
    name: "node"
    path: "/usr/bin/nodejs"
  sudo: "yes"

- name: "install node packages"
  action:
    module: "npm"
    name: "{{ item }}"
    global: "yes"
  sudo: "yes"
  with_items: "api_install_node"
  tags: "update"

- name: "deploy projects"
  delegate_to: "localhost"
  shell:

    set -e;

    rsync
      --archive
      --delete
      --itemize-changes
      {{ deployment_home }}/{{ deployment }}/{{ item }}/
      /var/lib/lxc/{{ deployment }}-{{ inventory_hostname }}/rootfs/home/ubuntu/{{ item }}/
      --exclude /.git
      --exclude /config/config.local.js
      --exclude /node_modules;

  sudo: "yes"
  sudo_user: "root"
  register: "deploy_output"
  changed_when: "deploy_output.stdout != ''"
  tags: "quick"
  with_items:
    - "wistla-api"

- name: "deploy projects node modules"
  delegate_to: "localhost"
  shell:

    set -e;

    rsync
      --archive
      --delete
      --itemize-changes
      {{ deployment_home }}/{{ deployment }}/{{ item }}/node_modules/
      /var/lib/lxc/{{ deployment }}-{{ inventory_hostname }}/rootfs/home/ubuntu/{{ item }}/node_modules/;

  sudo: "yes"
  sudo_user: "root"
  register: "deploy_output"
  changed_when: "deploy_output.stdout != ''"
  with_items:
    - "wistla-api"

- name: "create api init config"
  action:
    module: "template"
    src: "wistla-api-init-conf"
    dest: "/etc/init/wistla-api.conf"
  sudo: "yes"
  notify: "reload upstart config"

- name: "create wistla api config"
  action:
    module: "file"
    path: "/home/ubuntu/wistla-api/config/config.local.js"
    state: "link"
    src: "/config/config.local.js"
    force: "yes"

- name: "install firewall rules"
  action:
    module: "template"
    src: "wistla-api-firewall-rules"
    dest: "/etc/network/firewall-rules"
    mode: "0755"
  sudo: "yes"

- name: "run firewall rules automatically"
  action:
    module: "file"
    path: "/etc/network/if-up.d/firewall-rules"
    state: "link"
    src: "../firewall-rules"
  sudo: "yes"

# ex: et ts=2 filetype=yaml
