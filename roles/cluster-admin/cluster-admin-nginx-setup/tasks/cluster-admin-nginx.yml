---

- name: "create nginx directories"
  with_items:

    - directory: "{{ nginx_config }}"
      user: "root"
      group: "root"
      mode: "0755"

    - directory: "{{ nginx_config }}/fragments"
      user: "root"
      group: "root"
      mode: "0755"

    - directory: "/var/log/nginx"
      user: "www-data"
      group: "adm"
      mode: "2750"

  become: "yes"
  action:

    module: "file"
    path: "{{ item.directory }}"
    state: "directory"

    owner: "{{ item.user }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"

- name: "upload nginx admin config"
  args:

    executable: "/bin/bash"

  connection: "local"
  shell:

    set -euf -o pipefail;

    rsync
      --perms
      --delete
      --recursive
      --rsync-path "sudo rsync"
      --exclude "/fragments"
      "{{ WORK }}/cluster/{{ cluster_name }}/nginx/"
      "{{ ansible_ssh_user }}@{{ ansible_ssh_host }}:{{ nginx_config }}/";

- name: "cluster admin nginx fragments"
  become: "yes"
  with_items:

    - target: "listen-insecure.conf"
      template: "cluster-admin-nginx-listen-insecure-fragment"

    - target: "listen-secure.conf"
      template: "cluster-admin-nginx-listen-secure-fragment"

  action:

    module: "template"
    dest: "{{ nginx_config }}/fragments/{{ item.target }}"
    src: "{{ item.template }}"

- name: "set nginx.state to 'enabled'"
  when: "nginx_state == 'installed'"
  update_resource:

    nginx.state: "enabled"

# ex: et ts=2 filetype=yaml
