---

- name: "install openvpn ca cert"
  action:
    module: "copy"
    src: "security/wistla-ca.cert"
    dest: "/etc/openvpn/wistla-ca.cert"
  sudo: "yes"
  notify: "restart openvpn"

- name: "install wistla-dh.pem"
  action:
    module: "copy"
    src: "security/wistla-dh.pem"
    dest: "/etc/openvpn/wistla-dh.pem"
  sudo: "yes"
  notify: "restart openvpn"

- name: "install openvpn server cert"
  action:
    module: "copy"
    src: "security/vpn-server/{{ cluster }}.cert"
    dest: "/etc/openvpn/wistla-{{ cluster }}-vpn.cert"
  sudo: "yes"
  notify: "restart openvpn"

- name: "install openvpn server key"
  action:
    module: "copy"
    src: "security/vpn-server/{{ cluster }}.key"
    dest: "/etc/openvpn/wistla-{{ cluster }}-vpn.key"
    mode: "0600"
  sudo: "yes"
  notify: "restart openvpn"

- name: "create openvpn config"
  action:
    module: "template"
    src: "cluster-admin-openvpn-config"
    dest: "/etc/openvpn/wistla-{{ cluster }}-vpn.conf"
  sudo: "yes"
  notify: "restart openvpn"

- name: "create openvpn client config dir"
  action:
    module: "file"
    name: "/etc/openvpn/clients"
    state: "directory"
  sudo: "yes"

- name: "create openvpn client configs"
  action:
    module: "template"
    src: "cluster-admin-openvpn-client-config"
    dest: "/etc/openvpn/clients/{{ item.name }}"
  sudo: "yes"
  with_items: "vpn_clients"

- name: "create openvpn client connect script"
  action:
    module: "template"
    src: "cluster-admin-openvpn-client-connect-script"
    dest: "/etc/openvpn/client-connect-script"
    mode: "0755"
  sudo: "yes"

- name: "create openvpn client disconnect script"
  action:
    module: "template"
    src: "cluster-admin-openvpn-client-disconnect-script"
    dest: "/etc/openvpn/client-disconnect-script"
    mode: "0755"
  sudo: "yes"

- meta: "flush_handlers"

# ex: et ts=2 filetype=yaml
