---

- name: "install icinga htpasswd"
  action:
    module: "template"
    src: "icinga-htpasswd"
    dest: "/etc/icinga2-classicui/htpasswd.users"
    owner: "root"
    group: "www-data"
    mode: "0640"
  sudo: "yes"

- name: "install icinga cgi config"
  action:
    module: "template"
    src: "icinga-classicui-cgi"
    dest: "/etc/icinga2-classicui/cgi.cfg"
  sudo: "yes"

- name: "create icinga gui log dir"
  action:
    module: "file"
    path: "/var/log/icinga2/gui"
    state: "directory"
    owner: "www-data"
    group: "adm"
    mode: "0750"
  sudo: "yes"

- name: "create icinga configs"
  action:
    module: "template"
    src: "{{ item.src }}"
    dest: "/etc/icinga2/{{ item.dest }}"
  sudo: "yes"
  with_items:

    - src: "icinga-config"
      dest: "icinga2.conf"

    - src: "icinga-constants-config"
      dest: "constants.conf"

    - src: "icinga-zones-config"
      dest: "zones.conf"

  sudo: "yes"
  notify: "restart icinga"

- name: "create icinga zone directories"
  action:
    module: "file"
    path: "/etc/icinga2/zones.d/{{ item }}"
    state: "directory"
  sudo: "yes"
  when: "cluster == 'ops' and zon == 'a'"
  with_items:
    - "global-templates"
    - "wistla-ops"
    - "wistla-production"
    - "wistla-staging"

- name: "create icinga zone configs"
  action:
    module: "template"
    src: "{{ item [1].src }}"
    dest: "/etc/icinga2/zones.d/wistla-{{ item [0] }}/{{ item [1].dest }}"
  sudo: "yes"
  when: "cluster == 'ops' and zon == 'a'"
  with_nested:

    - "clusters"

    - - src: "icinga-hosts-config"
        dest: "hosts.conf"

  sudo: "yes"
  notify: "restart icinga"

- name: "create icinga template configs"
  action:
    module: "template"
    src: "{{ item.src }}"
    dest: "/etc/icinga2/zones.d/global-templates/{{ item.dest }}"
  sudo: "yes"
  when: "cluster == 'ops' and zon == 'a'"
  with_items:

    - src: "icinga-templates-config"
      dest: "templates.conf"

  sudo: "yes"
  notify: "restart icinga"

- name: "create icinga credentials"
  action:
    module: "copy"
    src: "security/icinga/{{ item.src }}"
    dest: "/etc/icinga2/pki/{{ item.dest }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  sudo: "yes"
  with_items:

    - src: "wistla-icinga-ca.cert"
      dest: "wistla-icinga-ca.cert"
      owner: "root"
      group: "root"
      mode: "0644"

    - src: "wistla-{{ cluster }}-admin-{{ zon }}.cert"
      dest: "wistla-{{ cluster }}-admin-{{ zon }}.cert"
      owner: "root"
      group: "root"
      mode: "0644"

    - src: "wistla-{{ cluster }}-admin-{{ zon }}.key"
      dest: "wistla-{{ cluster }}-admin-{{ zon }}.key"
      owner: "root"
      group: "nagios"
      mode: "0640"

  notify: "restart icinga"

- name: "create icinga defaults"
  action:
    module: "template"
    src: "icinga-default"
    dest: "/etc/default/icinga2"
  sudo: "yes"
  notify: "restart icinga"

- meta: "flush_handlers"

# ex: et ts=2 filetype=yaml
