{{ ansible_warning ['#'] }}

{% import 'cluster-admin-nginx-macros' as macros with context %}

{% set dev_deployment = item %}

upstream {{ dev_deployment.name }}-host {
	server {{ dev_deployment.bridge_network }}.0.1;
}

upstream {{ dev_deployment.name }}-load {
	server {{ dev_deployment.bridge_network }}.0.4;
	server {{ dev_deployment.bridge_network }}.1.4;
	server {{ dev_deployment.bridge_network }}.2.4;
	server {{ dev_deployment.bridge_network }}.3.4;
}

# website redirect to www

server {

	server_name {{ dev_deployment.main_domain }};

{{ macros.listen_http () }}
{{ macros.listen_https () }}

{{ macros.ssl_certificate (dev_deployment.main_domain) }}

	return 301 https://{{ dev_deployment.web_domain }}$request_uri;

}

# website redirect to ssl

server {

	server_name {{ dev_deployment.web_domain }};

{{ macros.listen_http () }}

	return 301 https://{{ dev_deployment.web_domain }}$request_uri;

}

# website

server {

	server_name {{ dev_deployment.web_domain }};

{{ macros.listen_https () }}

{{ macros.ssl_certificate (dev_deployment.main_domain) }}

	add_header Strict-Transport-Security "max-age={{ 60 * 60 * 24 * 365 }}";

{% if dev_deployment.robots_override_main | default ('no') != 'yes' %}
{{ macros.dev_robots () }}
{% endif %}

	location / {
		proxy_pass http://{{ dev_deployment.name }}-load/;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

	location /keystone {
		auth_basic "Restricted";
		auth_basic_user_file {{ nginx_config_server }}/htpasswd;
		proxy_pass http://{{ dev_deployment.name }}-load/keystone;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

# api

server {

	server_name {{ dev_deployment.api_domain }};

{{ macros.listen_http () }}
{{ macros.listen_https () }}

{{ macros.ssl_certificate (dev_deployment.api_domain) }}

{{ macros.dev_robots () }}

	location / {
		proxy_pass http://{{ dev_deployment.name }}-load/;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

# admin redirect to ssl

server {

	server_name {{ dev_deployment.admin_domain }};

{{ macros.listen_http () }}

	return 301 https://{{ dev_deployment.admin_domain }}$request_uri;

}

# admin

server {

	server_name {{ dev_deployment.admin_domain }};

{{ macros.listen_https () }}

{{ macros.ssl_certificate (dev_deployment.admin_domain) }}

{{ macros.dev_robots () }}

	location / {
		proxy_pass http://{{ dev_deployment.name }}-load/;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

# short

server {

	server_name {{ dev_deployment.short_domain }};

{{ macros.listen_http () }}

	return 301 https://{{ dev_deployment.short_domain }}$request_uri;

}

server {

	server_name {{ dev_deployment.short_domain }};

{{ macros.listen_https () }}

{{ macros.ssl_certificate (dev_deployment.short_domain) }}

{% if dev_deployment.robots_override_short | default ('no') != 'yes' %}
{{ macros.dev_robots () }}
{% endif %}

	location / {
		proxy_pass http://{{ dev_deployment.name }}-load/;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

{% if 'test_domain' in dev_deployment %}

# test

server {

	server_name {{ dev_deployment.test_domain }};

{{ macros.listen_http () }}
{{ macros.listen_https () }}

{{ macros.ssl_certificate (dev_deployment.test_domain) }}

{{ macros.dev_robots () }}

	location / {
		proxy_pass http://{{ dev_deployment.name }}-host/;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

{% endif %}

# assets

server {

	server_name {{ dev_deployment.assets_domain }};

{{ macros.listen_http () }}
{{ macros.listen_https () }}

{{ macros.ssl_certificate (dev_deployment.assets_domain) }}

{% if dev_deployment.robots_override_assets | default ('no') != 'yes' %}
{{ macros.dev_robots () }}
{% endif %}

	location / {
		proxy_pass http://{{ dev_deployment.name }}-load/;
		proxy_set_header Host {{ dev_deployment.assets_domain }};
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

#	# assets redirect to ssl
#
#	server {
#
#
#		server_name {{ dev_deployment.assets_domain }};
#
#		return 301 https://{{ dev_deployment.assets_domain }}$request_uri;
#
#	}
