---

- name: "create deployment directories"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ item }}"
    state: "directory"
  with_items: "cluster_deployment_names"

- name: "checkout projects from git"
  shell:

    set -e;

    cd {{ vagrant_home }}/{{ item.0 }};

    git clone
      git@github.com:/wistla/{{ item.1.name }}
      --branch {{ item.1.branch }};

  args:
    creates: "{{ vagrant_home }}/{{ item.0 }}/{{ item.1.name }}"
  with_nested:

    - "cluster_deployment_names"
    - "cluster_checkouts"

- name: "run project build steps"
  shell: "{{ item.1.build_steps | default ([ 'true' ]) | join (' && ') }}"
  args:
    chdir: "{{ vagrant_home }}/{{ item.0 }}/{{ item.1.name }}"
  with_nested:
    - "cluster_deployment_names"
    - "cluster_checkouts"

- name: "create directories"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ item.0 }}/{{ item.1 }}"
    state: "directory"
  with_nested:

    - "cluster_deployment_names"

    - - "config"
      - "config/api"
      - "config/browser"
      - "config/load"
      - "config/mongo"
      - "config/rabbit"
      - "config/web"
      - "shared"

- name: "create config files"
  action:
    module: "template"
    src: "{{ item.1.source }}"
    dest: "{{ vagrant_home }}/{{ item.0 }}/{{ item.1.target }}"
  with_nested:

    - "cluster_deployment_names"

    - - source: "cluster-app-wistla-devops-config"
        target: "wistla-devops/config"

      - source: "cluster-app-wistla-devops-accounts"
        target: "wistla-devops/accounts"

      - source: "cluster-app-wistla-admin-config"
        target: "config/load/wistla-admin-config.local.js"

      - source: "cluster-app-wistla-api-config"
        target: "config/api/config.local.js"

      - source: "cluster-app-wistla-browser-config"
        target: "config/browser/config.local.js"

      - source: "cluster-app-wistla-web-config"
        target: "config/web/config.local.js"

      - source: "cluster-app-wistla-load-upstream"
        target: "config/load/nginx-upstream.conf"

- name: "copy config files"
  action:
    module: "copy"
    src: "{{ item.1.source }}"
    dest: "{{ vagrant_home }}/{{ item.0 }}/{{ item.1.target }}"
    mode: "{{ item.1.mode }}"
  with_nested:

    - "cluster_deployment_names"

    - - source: "security/test/google-service-account.key"
        target: "config/api/google-service-account.key"
        mode: "0600"

- name: "create links to config files"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ item.0 }}/{{ item.1.target }}"
    src: "{{ item.1.source }}"
    state: "link"
    force: "yes"
  with_nested:

    - "cluster_deployment_names"

    - - source: "../../config/api/config.local.js"
        target: "wistla-api/config/config.local.js"

      - source: "../../config/browser/config.local.js"
        target: "wistla-browser/config/config.local.js"

      - source: "../../config/web/config.local.js"
        target: "wistla-web/config/config.local.js"

# ex: et ts=2 filetype=yaml
