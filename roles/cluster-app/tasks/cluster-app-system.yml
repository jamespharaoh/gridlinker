---

- name: "create common groups"
  action:
    module: "group"
    name: "{{ item.name }}"
    gid: "{{ item.gid }}"
    system: "yes"
  sudo: "yes"
  sudo_user: "root"
  with_items: "common_users"

- name: "create common users"
  action:
    module: "user"
    name: "{{ item.name }}"
    group: "{{ item.name }}"
    uid: "{{ item.uid }}"
    home: "{{ item.home }}"
    createhome: "no"
    shell: "{{ item.shell }}"
    system: "yes"
  sudo: "yes"
  sudo_user: "root"
  with_items: "common_users"

- name: "remove system packages"
  action:
    module: "apt"
    state: "absent"
    name: "{{ item }}"
    purge: "yes"
  sudo: "yes"
  sudo_user: "root"
  with_items: "cluster_app_remove_packages"

- name: "install system packages"
  action:
    module: "apt"
    state: "present"
    name: "{{ item }}"
  sudo: "yes"
  sudo_user: "root"
  with_items: "cluster_app_install_packages"

- name: "setup sudo"
  action:
    module: "template"
    src: "sudoers-ssh-agent"
    dest: "/etc/sudoers.d/ssh-agent"
  sudo: "yes"
  sudo_user: "root"

- name: "install python packages"
  action:
    module: "pip"
    name: "{{ item }}"
  sudo: "yes"
  sudo_user: "root"
  with_items: "cluster_app_install_python"
  tags: "update"

- name: "set hostname"
  action:
    module: "copy"
    dest: "/etc/hostname"
    content: "{{ hostname + '\n' }}"
  sudo: "yes"
  register: "hostname_result"

- name: "update hostname"
  shell: "hostname {{ hostname }}"
  sudo: "yes"
  when: "hostname_result.changed"

# ex: et ts=2 filetype=yaml
