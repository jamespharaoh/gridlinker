---

- name: "setup sudo"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/sudoers.d/ssh-agent"
    src: "devbox-sudoers-ssh-agent"

- name: "install ssh known hosts"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/ssh/ssh_known_hosts"
    src: "devbox-ssh-known-hosts"

- name: "get info about second disk"
  register: "sdb_result"
  action:

    module: "stat"
    path: "/dev/sdb"

- name: "check second disk is present"
  when: "not sdb_result.stat.exists"
  action:

    module: "fail"
    msg: "please add second drive to virtual machine"

- name: "setup second disk"
  sudo: "yes"
  args:

    creates: "/datingnode-local/.setup-flag"
    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    parted /dev/sdb --script
      --align none
      --
      mklabel gpt;

    parted /dev/sdb --script
      --align none
      --
      unit mb
      mkpart primary ext4 0 -0;

    mkfs.ext4 /dev/sdb1;

    mkdir -p /datingnode-local;

    echo '/dev/sdb1 /datingnode-local ext4 defaults 0 0'
      >>/etc/fstab;

    mount /datingnode-local;

    touch /datingnode-local/.setup-flag;

    true;

# ex: et ts=2 filetype=yaml
