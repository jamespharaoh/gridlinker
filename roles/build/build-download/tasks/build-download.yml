---

- name: "download builds"
  args:

    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    exec 200>{{ builds_path }}/lock;
    flock --exclusive 200;

    if test "{{ deployment_mode }}" = "vagrant"; then
      eval $({{ HOME }}/misc/amazon-auth ops);
    fi;

    if test "{{ deployment_mode }}" = "jenkins"; then

      aws s3 sync
        --size-only
        --exclude 'snapshots/*'
        "s3://wistla-builds/zbackup"
        "{{ builds_path }}";

    else

      aws s3 sync
        --size-only
        --delete
        --exclude 'snapshots/*'
        "s3://wistla-builds/zbackup"
        "{{ builds_path }}";

    fi;

# ex: et ts=2 filetype=yaml
