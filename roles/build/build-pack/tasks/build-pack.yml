---

- name: "create directory"
  delegate_to: "localhost"
  run_once: "true"
  action:

    module: "file"
    path: "{{ deployment_home }}/work/build"
    state: "directory"

- name: "create package"
  delegate_to: "localhost"
  environment:

    build_source: "/var/lib/lxc/{{ inventory_hostname }}/rootfs"

    build_target: "{{ [
      deployment_home,
      '/builds/backups/',
      node_type,
      '-',
      local_build_id,
      '.tar',
    ] | join }}"

  args:

    creates: "{{ [
      deployment_home,
      '/builds/backups/',
      node_type,
      '-',
      local_build_id,
      '.tar',
    ] | join }}"

    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    {
      sudo tar
        --create
        --directory "$build_source"
        ".";
    } | {
      zbackup backup "$build_target.temp"
        --password-file "{{ deployment_build_secret_path }}"
        --silent;
    };

    mv "$build_target.temp" "$build_target";

# ex: et ts=2 filetype=yaml
