#!/bin/bash

set -e

export HOME="/root"
PROJECT="$HOME/datingnode-ansible"

cd "$PROJECT"

export ANSIBLE_HOME="$PROJECT/third-party/ansible"
export ANSIBLE_CONFIG="$PROJECT/work/ansible.cfg"

export PATH="$ANSIBLE_HOME/bin:$PATH"
export PYTHONPATH="$ANSIBLE_HOME/lib"

mkdir -p work

cat >work/ansible.cfg <<-END
	[defaults]
	library = $PROJECT/third-party/ansible-modules-core:$PROJECT/third-party/ansible-modules-extras
	roles_path = $PROJECT/roles/config
END

cp /config/runtime-config config/runtime-config
cp /config/parent-config config/parent-config
cp /config/inventory config/inventory

ansible-playbook \
	--connection "local" \
	--inventory "config/inventory" \
	--extra-vars "@config/build-config" \
	--extra-vars "@config/runtime-config" \
	--extra-vars "@config/parent-config" \
	"playbooks/config.yml"

# ex: noet ts=4 filetype=sh
