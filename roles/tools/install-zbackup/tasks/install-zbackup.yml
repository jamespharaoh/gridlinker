---

- name: "install zbackup dependencies"
  when: "ubuntu_release == 'trusty'"
  with_items:

    - "libprotobuf8"
    - "libunwind8"

  become: "yes"
  action:

    module: "apt"
    name: "{{ item }}"

- name: "install zbackup dependencies"
  when: "ubuntu_release == 'xenial'"
  with_items:

    - "libprotobuf9v5"
    - "libunwind8"

  become: "yes"
  action:

    module: "apt"
    name: "{{ item }}"

- name: "install zbackup"
  args:

    creates: "/opt-zbackup-{{ zbackup_version }}"
    executable: "/bin/bash"

  become: "yes"
  shell:

    set -euf -o pipefail;

    rm -rf {{ zbackup_temp }};
    mkdir -p {{ zbackup_temp }};
    cd {{ zbackup_temp }};

    wget --quiet {{ zbackup_url }};

    tar --extract --xz --file {{ zbackup_archive }};

    rsync --archive --delete
      {{ zbackup_directory }}/
      {{ zbackup_target }}/;

    rm -rf {{ zbackup_temp }};

- name: "create symlinks to zbackup bins"
  register: "zbackup_symlinks_result"
  changed_when: "zbackup_symlinks_result.stdout != 'UNCHANGED'"
  become: "yes"
  args:

    executable: "/bin/bash"
    chdir: "{{ zbackup_target }}/bin"

  shell:

    set -euf -o pipefail;

    changed="";

    while read filename; do

      if ! test -x "$filename"; then
        continue;
      fi;

      if test -h "/usr/local/bin/$filename"; then
        rm "/usr/local/bin/$filename";
      fi;

      changed="yes";

      ln -s "../../..{{ zbackup_target }}/bin/$filename"
        "/usr/local/bin/$filename";

    done < <(ls);

    if ! test "$changed"; then
      echo "UNCHANGED";
    fi;

# ex: et ts=2 filetype=yaml
