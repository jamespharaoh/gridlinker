---

- name: "install ntp"
  become: "yes"
  action:

    module: "apt"
    name: "ntp"

- name: "write vm fstab"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/fstab"
    src: "datingnode-vm-fstab"

- name: "write vm mount script"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/mount-script"
    src: "datingnode-vm-mount-script"

    mode: "0755"

- name: "write encfs keys"
  with_dict: "{{ deployment_clusters }}"
  when: "'cluster' in item.value and 'encfs_key' in item.value.cluster"
  become: "yes"
  action:

    module: "copy"
    dest: "{{ [
      '/datingnode-',
      item.key,
      '/',
      item.key,
      '-web-application-',
      identity_index,
      '/user-data-encryption-key',
    ] | join }}"
    content: "{{ item.value.cluster.encfs_key }}"

    owner: "root"
    group: "root"
    mode: "0600"

- name: "write encfs helpers"
  with_dict: "{{ deployment_clusters }}"
  when: "'cluster' in item.value and 'encfs_key' in item.value.cluster"
  become: "yes"
  action:

    module: "template"
    dest: "{{ [
      '/datingnode-',
      item.key,
      '/',
      item.key,
      '-web-application-',
      identity_index,
      '/big/user-data-helper',
    ] | join }}"
    src: "datingnode-vm-user-data-helper"

    owner: "root"
    group: "root"
    mode: "0755"

- name: "install database backup script"
  tags: "vm-backup-script"
  sudo: "yes"
  action:

    module: "copy"
    dest: "/usr/local/bin/database-backup-script"
    src: "datingnode-vm-database-backup-script"

    mode: "0755"

- name: "install database backup config"
  tags: "vm-backup-config"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/database-backup-config"
    src: "datingnode-vm-database-backup-config"

    mode: "0600"

- name: "configure nfs exports"
  notify: "reload nfs server"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/exports"
    src: "datingnode-vm-nfs-exports"

- name: "install system logrotate config"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/logrotate.conf"
    src: "datingnode-vm-logrotate"

- meta: "flush_handlers"

- name: "configure cron"
  tags: "vm-backup-cron"
  notify: "restart cron"
  sudo: "yes"
  action:

    module: "template"
    src: "datingnode-vm-cron"
    dest: "/etc/cron.d/datingnode"

- meta: "flush_handlers"

- name: "upload ssls"
  connection: "local"
  sudo: "yes"
  shell:

    rsync \
      --archive \
      /datingnode-ssl/ \
      root@{{ public.address }}:/datingnode-ssl/;

# ex: et ts=2 filetype=yaml
