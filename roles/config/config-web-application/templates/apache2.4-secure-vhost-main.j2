# {{ ansible_managed }}

<VirtualHost *:80>

	ServerName secure.datingnode.com
	ServerAlias secure.{{ cluster.cluster.domain_suffix }}

	ServerAdmin {{ server_admin_email }}

	DocumentRoot {{ platform_super_dir }}

	SetEnv DATINGNODE_ENVIRONMENT_CONFIG /var/www/datingnode-config.json

	<Directory {{ platform_super_dir }}/>

		Options FollowSymLinks
		AllowOverride none
		Require all granted

		<FilesMatch "\.(ttf|otf|eot|woff)$">
			<IfModule mod_headers.c>
				Header set Access-Control-Allow-Origin "*"
			</IfModule>
		</FilesMatch>

		RewriteEngine on

        RewriteRule  ^css/(.*)$ 	{{platform_super_dir}}/datingnode/www/css/$1 [L,END]
        RewriteRule ^img/(.*)$ 		{{platform_super_dir}}/datingnode/www/img/$1 [L,END]
        RewriteRule ^js/(.*)$ 		{{platform_super_dir}}/datingnode/www/js/$1 [L,END]
        RewriteRule ^font/(.*)$ 	{{platform_super_dir}}/datingnode/www/font/$1 [L,END]


        RewriteCond %{REQUEST_URI} !php$
        RewriteCond %{REQUEST_URI} !datingnode/www/
        RewriteRule ^(.*)$ fcgi://127.0.0.1:9000{{platform_super_dir}}/datingnode/index.php [P]

	</Directory>

	ProxyPassMatch ^/(.*\.php(/.*)?)$ fcgi://127.0.0.1:9000{{platform_super_dir}}$1

	<Location />

		<IfModule mod_filter.c>
		<IfModule mod_deflate.c>
		AddOutputFilterByType DEFLATE application/atom+xml \
			application/javascript \
			application/json \
			application/rss+xml \
			application/vnd.ms-fontobject \
			application/x-font-ttf \
			application/xhtml+xml \
			application/xml \
			font/opentype \
			image/svg+xml \
			image/x-icon \
			text/css \
			text/html \
			text/plain \
			text/x-component \
			text/xml
		</IfModule>
		</IfModule>

	</Location>

	CustomLog {{ platform_log_dir }}/secure-apache-access.log combined
	ErrorLog {{ platform_log_dir }}/secure-apache-error.log
	LogLevel warn

</VirtualHost>
