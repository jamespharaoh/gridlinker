---

- set_fact:

    verify_mounts:

      - "/data/logs"
      - "/data/assets/image-cache"
      - "/data/assets/sitemaps"
      - "/data/assets/user-data"
      - "/data/temp"

- name: "stat mount flags"
  with_items: "{{ verify_mounts }}"
  register: "stat_mount_flags_result"
  become: "yes"
  action:

    module: "stat"
    path: "{{ item }}/mount-flag"

- name: "check mount flags"
  with_indexed_items: "{{ verify_mounts }}"
  when: "not stat_mount_flags_result.results [item.0].stat.exists"
  fail:

    msg: "{{ item.1 }}/mount-flag does not exist"

- include: "site.yml"
  label: "control"
  prefix: "dp_control"
  suffix: "main"
  config: "apache{{ apache_version }}-control-vhost-main.j2"
  sites:

    - main_domain: "control.datingnode.com"
      enabled: true
      
- include: "site.yml"
  label: "secure"
  prefix: "dp_secure"
  suffix: "main"
  config: "apache{{ apache_version }}-secure-vhost-main.j2"
  sites:

    - main_domain: "secure.datingnode.com"
      enabled: true
      
- include: "site.yml"
  label: "cdn"
  prefix: "dp_cdn"
  suffix: "main"
  config: "apache{{ apache_version }}-cdn-vhost-main.j2"
  sites:

    - main_domain: "cdn.datingnode.com"
      enabled: true
      
- include: "site.yml"
  label: "api"
  prefix: "dp_api"
  suffix: "main"
  config: "apache{{ apache_version }}-api-vhost-main.j2"
  sites:
    - main_domain: "api.datingnode.com"
      enabled: true

- include: "site.yml"
  label: "service"
  prefix: "dp_service"
  suffix: "main"
  config: "apache{{ apache_version }}-service-vhost-main.j2"
  sites: "{{ services }}"
  
- include: "site.yml"
  label: "service"
  prefix: "dp_service"
  suffix: "app-web"
  config: "apache{{ apache_version }}-service-vhost-app-web.j2"
  sites: "{{ services }}"

- include: "site.yml"
  label: "api"
  prefix: "dp_service"
  suffix: "api"
  config: "apache{{ apache_version }}-service-vhost-api.j2"
  sites: "{{ services }}"

- include: "site.yml"
  label: "cdn"
  prefix: "dp_service"
  suffix: "cdn"
  config: "apache{{ apache_version }}-service-vhost-cdn.j2"
  sites: "{{ services }}"

- name: "create datingnode-config.json"
  action:
    module: "template"
    src: "datingnode-config"
    dest: "/var/www/datingnode-config.json"
  sudo: "yes"

# ex: et ts=2 filetype=yaml
