---

- set_fact:

    cluster_deployment: "{{ deployments [cluster_deployment_name] }}"

- set_fact:

    cluster_deployment_alias: "{{
      deployment_aliases [cluster_deployment.alias]
      if cluster_deployment.alias is defined
      else cluster_deployment
    }}"

- set_fact:

    config_directories:

      - "config"
      - "config/api"
      - "config/browser"
      - "config/load"
      - "config/mongo"
      - "config/rabbit"
      - "config/web"

    config_files:

      - source: "security/test/google-service-account.key"
        target: "config/api/google-service-account.key"
        mode: "0600"

      - source: "security/apple/push-notifications/ca.cert"
        target: "config/api/apple-ca.cert"
        mode: "0644"

      - source: "security/apple/push-notifications/{{ cluster_deployment.apple_push_notifications }}.cert"
        target: "config/api/apple-push.cert"
        mode: "0644"

      - source: "security/apple/push-notifications/{{ cluster_deployment.apple_push_notifications }}.key"
        target: "config/api/apple-push.key"
        mode: "0600"

    config_templates:

      - template: "cluster-deployment-wistla-devops-config"
        target: "wistla-devops/config"

      - template: "cluster-deployment-wistla-devops-accounts"
        target: "wistla-devops/accounts"

      - template: "cluster-deployment-wistla-admin-config"
        target: "config/load/wistla-admin-config.local.js"

      - template: "cluster-deployment-wistla-api-config"
        target: "config/api/config.local.js"

      - template: "cluster-deployment-wistla-browser-config"
        target: "config/browser/config.local.js"

      - template: "cluster-deployment-wistla-web-config"
        target: "config/web/config.local.js"

      - template: "cluster-deployment-wistla-load-upstream"
        target: "config/load/nginx-upstream.conf"

    config_links:

      - source: "../../config/api/config.local.js"
        target: "wistla-api/config/config.local.js"

      - source: "../../config/browser/config.local.js"
        target: "wistla-browser/config/config.local.js"

      - source: "../../config/web/config.local.js"
        target: "wistla-web/config/config.local.js"

    shared_directories:

      - "shared"
      - "shared/audio"
      - "shared/cms-image"
      - "shared/image"
      - "shared/log"
      - "shared/user-upload"
      - "shared/video"

- name: "create deployment directories"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ cluster_deployment_name }}"
    state: "directory"

- name: "checkout projects from git"
  shell:

    set -e;

    cd {{ vagrant_home }}/{{ cluster_deployment_name }};

    git clone
      git@github.com:/wistla/{{ item.name }}
      --branch {{ item.branch }};

  args:
    creates: "{{ vagrant_home }}/{{ cluster_deployment_name }}/{{ item.name }}"
  with_items: "cluster_checkouts"

- name: "run project build steps"
  shell: "{{ item.build_steps | default ([ 'true' ]) | join (' && ') }}"
  args:
    chdir: "{{ vagrant_home }}/{{ cluster_deployment_name }}/{{ item.name }}"
  tags: "build"
  with_items: "cluster_checkouts"

- name: "create config directories"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ cluster_deployment_name }}/{{ item }}"
    state: "directory"
  tags: "cluster-app-wistla-config"
  with_items: "config_directories"

- name: "create shared directories"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ cluster_deployment_name }}/{{ item }}"
    state: "directory"
  tags: "cluster-app-wistla-config"
  with_items: "shared_directories"

- name: "create config files"
  action:
    module: "template"
    src: "{{ item.template }}"
    dest: "{{ vagrant_home }}/{{ cluster_deployment_name }}/{{ item.target }}"
  tags: "cluster-app-wistla-config"
  with_items: "config_templates"

- name: "copy config files"
  action:
    module: "copy"
    src: "{{ item.source }}"
    dest: "{{ vagrant_home }}/{{ cluster_deployment_name }}/{{ item.target }}"
    mode: "{{ item.mode }}"
  tags: "cluster-app-wistla-config"
  with_items: "config_files"

- name: "create links to config files"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ cluster_deployment_name }}/{{ item.target }}"
    src: "{{ item.source }}"
    state: "link"
    force: "yes"
  with_items: "config_links"

# ex: et ts=2 filetype=yaml
