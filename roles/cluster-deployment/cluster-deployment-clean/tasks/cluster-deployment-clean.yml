---

- name: "clean templates"
  args:

    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    cd "{{ cluster_deployment_home }}/wistla-devops";

    ./run-ansible || true;

    ./run-ansible playbooks/clean-templates.yml;

- name: "remove project links"
  with_items: "{{ cluster_deployment_checkouts | flatten_hash ('project_links') }}"
  become: "yes"
  args:

    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    link="{{ [
      cluster_deployment_home,
      item.outer.name,
      item.project_links.link,
    ] | join ('/') }}";

    overlay="{{ [
      cluster_deployment_home,
      item.outer.name,
      item.project_links.overlay,
    ] | join ('/') }}";

    target="{{ item.project_links.target }}";

    if {
      cut -d' ' -f 2 </proc/mounts
        | grep -x "$link";
    }; then
      umount "$link";
    fi;

    if test -d "$overlay"; then
      rm -rf "$overlay";
    fi;

    if test -h "$link"; then
      rm "$link";
    fi;

- name: "clean checked out projects"
  with_items: "{{ cluster_deployment_checkouts }}"
  args:

    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    cd "{{ cluster_deployment_home }}/{{ item.name }}";

    git clean -xdf
      {{
        item.configs
        | default ([])
        | prepend_list ('--exclude ')
        | join (' ')
      }};

# ex: et ts=2 filetype=yaml
