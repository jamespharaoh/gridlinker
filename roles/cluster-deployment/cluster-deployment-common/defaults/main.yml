---

cluster_deployment: "{{ deployments [cluster_deployment_name] }}"

cluster_deployment_home: "/data/{{ cluster_deployment_name }}"

cluster_deployment_alias: "{{
  deployments [cluster_deployment.alias | default (cluster_deployment_name)]
}}"

cluster_deployment_type: "{{ cluster_deployment_types [cluster_deployment.type] }}"

cluster_deployment_checkouts: "{{ cluster_deployment_type.checkouts }}"
cluster_deployment_config_directories: "{{ cluster_deployment_type.config_directories }}"
cluster_deployment_config_templates: "{{ cluster_deployment_type.config_templates }}"
cluster_deployment_config_files: "{{ cluster_deployment_type.config_files }}"
cluster_deployment_config_links: "{{ cluster_deployment_type.config_links }}"
cluster_deployment_shared_directories: "{{ cluster_deployment_type.shared_directories }}"
cluster_deployment_shared_logfiles: "{{ cluster_deployment_type.shared_logfiles }}"
cluster_deployment_override_templates: "{{ cluster_deployment_type.override_templates }}"

cluster_deployment_types:

  # -------------------- shared

  shared:

    checkouts:

      - name: "wistla-devops"
        branch: "development"

      - name: "wistla-scripts"
        branch: "master"

    config_directories:

      - "mongo"
      - "rabbit"

    config_templates:

      - template: "cluster-deployment-wistla-devops-config"
        target: "wistla-devops/config/overrides.yml"

      - template: "cluster-deployment-wistla-devops-local"
        target: "wistla-devops/config/local.yml"

      - template: "cluster-deployment-wistla-devops-connections"
        target: "wistla-devops/config/connections.yml"

      - template: "cluster-deployment-wistla-devops-accounts"
        target: "wistla-devops/accounts"

      - template: "cluster-deployment-rabbit-erlang-cookie"
        target: "config/rabbit/erlang-cookie"
        owner: "rabbitmq"
        group: "root"
        mode: "0400"

    config_files: []
    config_links: []
    shared_directories: []
    shared_logfiles: []
    override_templates: []

  # -------------------- shared2

  shared2:

    checkouts:

      - name: "wistla-devops"
        branch: "development"

    config_directories:

      - "kafka"
      - "mongo"
      - "postgresql-main"
      - "postgresql-cache"
      - "rabbit"

    config_files: []

    config_templates:

      # ---------- devops

      - template: "cluster-deployment-wistla-devops-accounts"
        target: "wistla-devops/accounts"

      - template: "cluster-deployment-wistla-devops-config"
        target: "wistla-devops/config/overrides.yml"

      - template: "cluster-deployment-wistla-devops-local"
        target: "wistla-devops/config/local.yml"

      - template: "cluster-deployment-wistla-devops-connections"
        target: "wistla-devops/config/connections.yml"

      # ---------- kafka

      - template: "cluster-deployment-kafka-server-properties"
        target: "config/kafka/server.properties"

      - template: "cluster-deployment-kafka-consumer-properties"
        target: "config/kafka/consumer.properties"

      - template: "cluster-deployment-kafka-log4j-properties"
        target: "config/kafka/log4j.properties"

      # ---------- postgresql main

      - template: "cluster-deployment-postgresql-config"
        type: "postgresql-main"
        target: "config/postgresql-main/postgresql.conf"
        owner: "postgres"
        group: "postgres"
        mode: "0644"

      - template: "cluster-deployment-postgresql-hba-config"
        type: "postgresql-main"
        target: "config/postgresql-main/postgresql-hba.conf"
        owner: "postgres"
        group: "postgres"
        mode: "0640"

      # ---------- postgresql cache

      - template: "cluster-deployment-postgresql-config"
        type: "postgresql-cache"
        target: "config/postgresql-cache/postgresql.conf"
        owner: "postgres"
        group: "postgres"
        mode: "0644"

      - template: "cluster-deployment-postgresql-hba-config"
        type: "postgresql-cache"
        target: "config/postgresql-cache/postgresql-hba.conf"
        owner: "postgres"
        group: "postgres"
        mode: "0640"

      # ---------- rabbit

      - template: "cluster-deployment-rabbit-erlang-cookie"
        target: "config/rabbit/erlang-cookie"
        owner: "rabbitmq"
        group: "root"
        mode: "0400"

    config_links:

      - source: "/opt/node-v{{ cluster_deployment.nodejs_version }}-linux-x64"
        target: ".nodejs-stub-target"

    shared_directories:

      - directory: "log"
        user: "ubuntu"

      - directory: "log/kafka"
        user: kafka

    shared_logfiles:

      - log: "shared/log/mongodb.log"
        user: "mongodb"

      - log: "shared/log/postgresql-cache.log"
        user: "postgres"

      - log: "shared/log/postgresql-main.log"
        user: "postgres"

    override_templates: []

  # -------------------- alias

  alias:

    checkouts:

      - name: "content-browser"
        branch: "master"

      - name: "content-common"
        branch: "master"

      - name: "content-iOS"
        branch: "master"

      - name: "content-api"
        branch: "master"

      - name: "content-web"
        branch: "master"

#      - name: "wistla-admin"
#        branch: "master"
#        build_steps:
#
#          - "npm install"
#          - "jspm install -y"
#          - "./build.sh"

      - name: "wistla-analytics"
        branch: "master"
        build_steps:

          - "npm install"

      - name: "wistla-api"
        branch: "master"
        project_links:

          - link: "node_modules/wistla-analytics"
            overlay: "node_modules/.wistla-analytics"
            target: "../../wistla-analytics"

        build_steps:

          - "npm install"

      - name: "wistla-browser"
        branch: "master"
        project_links:

          - link: "node_modules/wistla-analytics"
            overlay: "node_modules/.wistla-analytics"
            target: "../../wistla-analytics"

        build_steps:

          - "npm install"

      - name: "wistla-devops"
        branch: "development"
        configs:

          - "config"
          - "data/runtime"
          - "security"

      - name: "wistla-scripts"
        branch: "master"

      - name: "wistla-test-images"
        branch: "master"

    config_directories:

      - "api"
      - "browser"
      - "load"

    config_files:

      - source: "security/test/google-service-account.key"
        target: "config/api/google-service-account.key"
        mode: "0600"

      - source: "security/apple/push-notifications/ca.cert"
        target: "config/api/apple-ca.cert"
        mode: "0644"

      - source: "security/apple/push-notifications/{{ cluster_deployment.apple_push_notifications_name | default ('none') }}.cert"
        target: "config/api/apple-push.cert"
        mode: "0644"

      - source: "security/apple/push-notifications/{{ cluster_deployment.apple_push_notifications_name | default ('none') }}.key"
        target: "config/api/apple-push.key"
        mode: "0600"

    config_links:

      - source: "../../config/api/config.local.js"
        target: "wistla-api/config/config.local.js"

      - source: "../../config/api/config.overrides.js"
        target: "wistla-api/config/config.overrides.js"

      - source: "../../config/browser/config.local.js"
        target: "wistla-browser/config/config.local.js"

      - source: "../../config/browser/config.overrides.js"
        target: "wistla-browser/config/config.overrides.js"

    config_templates:

      # api

      - template: "cluster-deployment-wistla-api-config"
        target: "config/api/config.local.js"

      - template: "cluster-deployment-wistla-api-environment"
        target: "config/api/environment"

      # browser

      - template: "cluster-deployment-wistla-browser-config"
        target: "config/browser/config.local.js"

      - template: "cluster-deployment-wistla-browser-environment"
        target: "config/browser/environment"

      # devops

      - template: "cluster-deployment-wistla-devops-config"
        target: "wistla-devops/config/overrides.yml"

      - template: "cluster-deployment-wistla-devops-local"
        target: "wistla-devops/config/local.yml"

      - template: "cluster-deployment-wistla-devops-connections"
        target: "wistla-devops/config/connections.yml"

      - template: "cluster-deployment-wistla-devops-accounts"
        target: "wistla-devops/accounts"

      # load

      - template: "cluster-deployment-wistla-load-nginx-config"
        target: "config/load/nginx-config"

      - template: "cluster-deployment-wistla-admin-config"
        target: "config/load/wistla-admin-config.local.js"

    shared_directories: []

    shared_logfiles: []

    override_templates:

      - template: "cluster-deployment-wistla-api-overrides"
        target: "config/api/config.overrides.js"

      - template: "cluster-deployment-wistla-browser-overrides"
        target: "config/browser/config.overrides.js"

  # -------------------- alias2

  alias2:

    checkouts:

      - name: "wistla-devops"
        branch: "development"
        configs:

          - "config"
          - "data/runtime"
          - "security"

      - name: "wistla-scripts"
        branch: "master"

    config_directories:

      - "api2"
      - "browser"
      - "db-daemon"
      - "load"
      - "media"
      - "notifications"

    config_files: []

    config_links: []

    config_templates:

      # api2

      - template: "cluster-deployment-wistla-api2-schema-config"
        target: "config/api2/wistla-db-schema-local.yaml"

      - template: "cluster-deployment-wistla-api2-server-config"
        target: "config/api2/wistla-api-server-local.yaml"

      - template: "cluster-deployment-wistla-api2-environment"
        target: "config/api2/environment"

      # db-daemon

      - template: "cluster-deployment-wistla-api2-server-config"
        target: "config/db-daemon/wistla-db-daemon-local.yaml"

      - template: "cluster-deployment-wistla-db-daemon-environment"
        target: "config/db-daemon/environment"

      # media

      - template: "cluster-deployment-wistla-api2-server-config"
        target: "config/media/wistla-media-daemon-local.yaml"

      - template: "cluster-deployment-wistla-media-environment"
        target: "config/media/environment"

      # notifications

      - template: "cluster-deployment-wistla-api2-server-config"
        target: "config/notifications/wistla-notification-daemon-local.yaml"

      - template: "cluster-deployment-wistla-notifications-environment"
        target: "config/notifications/environment"

      # devops

      - template: "cluster-deployment-wistla-devops-config"
        target: "wistla-devops/config/overrides.yml"

      - template: "cluster-deployment-wistla-devops-local"
        target: "wistla-devops/config/local.yml"

      - template: "cluster-deployment-wistla-devops-connections"
        target: "wistla-devops/config/connections.yml"

      - template: "cluster-deployment-wistla-devops-accounts"
        target: "wistla-devops/accounts"

      # load

      - template: "cluster-deployment-wistla-load-nginx-config"
        target: "config/load/nginx-config"

      - template: "cluster-deployment-wistla-admin-config"
        target: "config/load/wistla-admin-config.local.js"

    shared_directories:

      - directory: "log"
        user: "ubuntu"

    shared_logfiles: []

    override_templates: []

  # -------------------- simple

  simple:

    checkouts:

      - name: "content-api"
        branch: "master"

      - name: "content-browser"
        branch: "master"

      - name: "content-common"
        branch: "master"

      - name: "content-iOS"
        branch: "master"

      - name: "content-web"
        branch: "master"

#      - name: "wistla-admin"
#        branch: "master"
#        build_steps:
#
#          - "npm install"
#          - "jspm install -y"
#          - "./build.sh"

      - name: "wistla-analytics"
        branch: "master"
        build_steps:

          - "npm install"

      - name: "wistla-api"
        branch: "master"
        project_links:

          - link: "node_modules/wistla-analytics"
            target: "../../wistla-analytics"

        build_steps:

          - "npm install"

      - name: "wistla-browser"
        branch: "master"
        project_links:

          - link: "node_modules/wistla-analytics"
            target: "../../wistla-analytics"

        build_steps:

          - "npm install"

      - name: "wistla-devops"
        branch: "development"
        configs:

          - "config"
          - "data/runtime"
          - "security"

      - name: "wistla-scripts"
        branch: "master"

      - name: "wistla-test-images"
        branch: "master"

    config_directories:

      - "api"
      - "browser"
      - "load"
      - "mongo"
      - "rabbit"

    config_files:

      - source: "security/test/google-service-account.key"
        target: "config/api/google-service-account.key"
        mode: "0600"

      - source: "security/apple/push-notifications/ca.cert"
        target: "config/api/apple-ca.cert"
        mode: "0644"

      - source: "security/apple/push-notifications/{{ cluster_deployment.apple_push_notifications_name | default ('none') }}.cert"
        target: "config/api/apple-push.cert"
        mode: "0644"

      - source: "security/apple/push-notifications/{{ cluster_deployment.apple_push_notifications_name | default ('none') }}.key"
        target: "config/api/apple-push.key"
        mode: "0600"

    config_templates:

      # admin

      - template: "cluster-deployment-wistla-admin-config"
        target: "config/load/wistla-admin-config.local.js"

      # api

      - template: "cluster-deployment-wistla-api-config"
        target: "config/api/config.local.js"

      - template: "cluster-deployment-wistla-api-environment"
        target: "config/api/environment"

      # browser

      - template: "cluster-deployment-wistla-browser-config"
        target: "config/browser/config.local.js"

      - template: "cluster-deployment-wistla-browser-environment"
        target: "config/browser/environment"

      # devops

      - template: "cluster-deployment-wistla-devops-accounts"
        target: "wistla-devops/accounts"

      - template: "cluster-deployment-wistla-devops-config"
        target: "wistla-devops/config/overrides.yml"

      - template: "cluster-deployment-wistla-devops-local"
        target: "wistla-devops/config/local.yml"

      - template: "cluster-deployment-wistla-devops-connections"
        target: "wistla-devops/config/connections.yml"

      # load

      - template: "cluster-deployment-wistla-load-nginx-config"
        target: "config/load/nginx-config"

      # rabbit

      - template: "cluster-deployment-rabbit-erlang-cookie"
        target: "config/rabbit/erlang-cookie"
        owner: "rabbitmq"
        group: "root"
        mode: "0400"

    config_links:

      - source: "../../config/api/config.local.js"
        target: "wistla-api/config/config.local.js"

      - source: "../../config/api/config.overrides.js"
        target: "wistla-api/config/config.overrides.js"

      - source: "../../config/browser/config.local.js"
        target: "wistla-browser/config/config.local.js"

      - source: "../../config/browser/config.overrides.js"
        target: "wistla-browser/config/config.overrides.js"

      - source: "/opt/node-v{{ cluster_deployment.nodejs_version }}-linux-x64"
        target: ".nodejs-stub-target"

    shared_directories:

      - directory: "audio"
        user: "ubuntu"

      - directory: "cms-image"
        user: "ubuntu"

      - directory: "image"
        user: "ubuntu"

      - directory: "log"
        user: "ubuntu"

      - directory: "user-upload"
        user: "ubuntu"

      - directory: "video"
        user: "ubuntu"

    shared_logfiles: []

    override_templates:

      - template: "cluster-deployment-wistla-api-overrides"
        target: "config/api/config.overrides.js"

      - template: "cluster-deployment-wistla-browser-overrides"
        target: "config/browser/config.overrides.js"

  # -------------------- simple2

  simple2:

    checkouts:

      - name: "wistla-devops"
        branch: "development"
        configs:

          - "config"
          - "data/runtime"
          - "security"

    config_directories:

      - "api2"
      - "browser"
      - "db-daemon"
      - "kafka"
      - "load"
      - "media"
      - "mongo"
      - "notifications"
      - "postgresql-main"
      - "postgresql-cache"
      - "rabbit"

    config_files: []

    config_templates:

      # admin

      - template: "cluster-deployment-wistla-admin-config"
        target: "config/load/wistla-admin-config.local.js"

      # api2

      - template: "cluster-deployment-wistla-api2-schema-config"
        target: "config/api2/wistla-db-schema-local.yaml"

      - template: "cluster-deployment-wistla-api2-server-config"
        target: "config/api2/wistla-api-server-local.yaml"

      - template: "cluster-deployment-wistla-api2-environment"
        target: "config/api2/environment"

      # db-daemon

      - template: "cluster-deployment-wistla-api2-server-config"
        target: "config/db-daemon/wistla-db-daemon-local.yaml"

      - template: "cluster-deployment-wistla-db-daemon-environment"
        target: "config/db-daemon/environment"

      # media

      - template: "cluster-deployment-wistla-api2-server-config"
        target: "config/media/wistla-media-daemon-local.yaml"

      - template: "cluster-deployment-wistla-media-environment"
        target: "config/media/environment"

      # notifications

      - template: "cluster-deployment-wistla-api2-server-config"
        target: "config/notifications/wistla-notification-daemon-local.yaml"

      - template: "cluster-deployment-wistla-notifications-environment"
        target: "config/notifications/environment"

      # browser

      - template: "cluster-deployment-wistla-browser-config"
        target: "config/browser/config.local.js"

      - template: "cluster-deployment-wistla-browser-environment"
        target: "config/browser/environment"

      # devops

      - template: "cluster-deployment-wistla-devops-accounts"
        target: "wistla-devops/accounts"

      - template: "cluster-deployment-wistla-devops-config"
        target: "wistla-devops/config/overrides.yml"

      - template: "cluster-deployment-wistla-devops-local"
        target: "wistla-devops/config/local.yml"

      - template: "cluster-deployment-wistla-devops-connections"
        target: "wistla-devops/config/connections.yml"

      # load

      - template: "cluster-deployment-wistla-load-nginx-config"
        target: "config/load/nginx-config"

      # ---------- kafka

      - template: "cluster-deployment-kafka-server-properties"
        target: "config/kafka/server.properties"

      - template: "cluster-deployment-kafka-consumer-properties"
        target: "config/kafka/consumer.properties"

      - template: "cluster-deployment-kafka-log4j-properties"
        target: "config/kafka/log4j.properties"

      # postgresql main

      - template: "cluster-deployment-postgresql-config"
        type: "postgresql-main"
        target: "config/postgresql-main/postgresql.conf"
        owner: "postgres"
        group: "postgres"
        mode: "0644"

      - template: "cluster-deployment-postgresql-hba-config"
        type: "postgresql-main"
        target: "config/postgresql-main/postgresql-hba.conf"
        owner: "postgres"
        group: "postgres"
        mode: "0640"

      # postgresql cache

      - template: "cluster-deployment-postgresql-config"
        type: "postgresql-cache"
        target: "config/postgresql-cache/postgresql.conf"
        owner: "postgres"
        group: "postgres"
        mode: "0644"

      - template: "cluster-deployment-postgresql-hba-config"
        type: "postgresql-cache"
        target: "config/postgresql-cache/postgresql-hba.conf"
        owner: "postgres"
        group: "postgres"
        mode: "0640"

      # rabbit

      - template: "cluster-deployment-rabbit-erlang-cookie"
        target: "config/rabbit/erlang-cookie"
        owner: "rabbitmq"
        group: "root"
        mode: "0400"

    config_links:

      - source: "/opt/node-v{{ cluster_deployment.nodejs_version }}-linux-x64"
        target: ".nodejs-stub-target"

    shared_directories:

      - directory: "flags"
        user: "ubuntu"

      - directory: "log"
        user: "ubuntu"

      - directory: "log/kafka"
        user: kafka

    shared_logfiles:

      - log: "shared/log/content-common.log"
        user: "root"

      - log: "shared/log/mongodb.log"
        user: "mongodb"

      - log: "shared/log/nginx-access.log"
        user: "root"

      - log: "shared/log/nginx-error.log"
        user: "root"

      - log: "shared/log/nginx-times.log"
        user: "root"

      - log: "shared/log/postgresql-cache.log"
        user: "postgres"

      - log: "shared/log/postgresql-main.log"
        user: "postgres"

      - log: "shared/log/wistla-analytics.log"
        user: "ubuntu"

      - log: "shared/log/wistla-api-server.log"
        user: "ubuntu"

      - log: "shared/log/wistla-db-daemon.log"
        user: "ubuntu"

      - log: "shared/log/wistla-media-daemon.log"
        user: "ubuntu"

      - log: "shared/log/wistla-notification-daemon.log"
        user: "ubuntu"

      - log: "shared/log/wistla-api.log"
        user: "ubuntu"

      - log: "shared/log/wistla-browser.log"
        user: "ubuntu"

    override_templates:

      - template: "cluster-deployment-wistla-browser-overrides"
        target: "config/browser/config.overrides.js"

# ex: et ts=2 filetype=yaml
