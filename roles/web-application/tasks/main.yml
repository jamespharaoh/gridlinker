---

  - name: Checkout the super project
    sudo: no
    git: repo=ssh://git@bitbucket.org/jimmyff/datingnode-super.git
         dest=/var/www/datingnode-super/
         version={{ platform_super_branch }}

  - name: Set super project permissions
    sudo: yes
    action: file owner=jimmyff group=www-data path=/var/www/datingnode-super/ recurse=yes state=directory

  - name: Make sure platform log directory exists
    action: file path={{ platform_log_dir }} state=directory

  - name: Make sure platform log directory exists
    action: file path={{ platform_assets_dir }} state=directory

  - name: Make sure platform assets directory exists
    action: file path={{ platform_assets_dir }} state=directory

  - name: Make sure platform image cache directory exists
    action: file path={{ platform_assets_dir }}image-cache/ state=directory

  - name: Make sure platform image cache directory exists
    action: file path={{ platform_assets_dir }}sitemaps/ state=directory

  - name: Make sure platform image cache directory exists
    action: file path={{ platform_assets_dir }}user-data/ state=directory


  - name: Setup the service virtualhosts (main domains)
    template:
      src=apache{{ apache_version }}-service-vhost-main.j2
      dest=/etc/apache2/sites-available/dp_service__{{ item.main_domain }}__main.conf
    with_items: services
    notify: Restart webserver



  - name: Enable active virtualhosts (main domains)
    action: command a2ensite dp_service__{{ item.main_domain }}__main.conf
    with_items: services
    when: item.enabled == true
    notify: Reload webserver


  - name: Disable inactive virtualhosts (main domains)
    action: command a2dissite dp_service__{{ item.main_domain }}__main.conf
    with_items: services
    when: item.enabled == false
    notify: Reload webserver



  - name: Setup the service virtualhosts (static domains)
    template:
      src=apache{{ apache_version }}-service-vhost-static.j2
      dest=/etc/apache2/sites-available/dp_service__{{ item.main_domain }}__static.conf
    with_items: services
    notify: Restart webserver

  - name: Enable active virtualhosts (static domains)
    action: command a2ensite dp_service__{{ item.main_domain }}__static.conf
    with_items: services
    when: item.enabled == true
    notify: Reload webserver

  - name: Disable inactive virtualhosts (static domains)
    action: command a2dissite dp_service__{{ item.main_domain }}__static.conf
    with_items: services
    when: item.enabled == false
    notify: Reload webserver
