---

- name: "create lxc container"
  action: shell

    set -i

    (
      set +e;
      lxc-stop
        --name {{ inventory_hostname }};
      lxc-destroy
        --name {{ inventory_hostname }};
    );

    lxc-create
      --template ubuntu
      --name {{ inventory_hostname }}
      --bdev btrfs
      --
      --mirror {{ ubuntu_url }}
      --release trusty
      --arch amd64
    &&
    chroot /var/lib/lxc/{{ inventory_hostname }}/rootfs
    apt-get update -qqy
    &&
    chroot /var/lib/lxc/{{ inventory_hostname }}/rootfs
    apt-get dist-upgrade -qqy
    &&
    chroot /var/lib/lxc/{{ inventory_hostname }}/rootfs
    apt-get install -qqy python
    &&
    touch /var/lib/lxc/{{ inventory_hostname }}/create-flag

  args:
    creates: "/var/lib/lxc/{{ inventory_hostname }}/create-flag"
  delegate_to: "localhost"
  sudo: "yes"
  sudo_user: "root"

- name: "create lxc config"
  action:
    module: "template"
    src: "lxc-config"
    dest: "/var/lib/lxc/{{ inventory_hostname }}/config"
  delegate_to: "localhost"
  sudo: "yes"
  sudo_user: "root"

# ex: et ts=2 filetype=yaml
