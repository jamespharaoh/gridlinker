---

- hosts: "host"
  tasks:

    - set_fact:
        icinga_state: "configuring"
      when: "icinga_state == 'unconfigured'"

    - name: "create ido database"
      when: "inventory_hostname == mysql_master and icinga_state == 'configuring'"
      action:
        module: "mysql_db"
        name: "icingaido"

    - name: "create ido user"
      when: "inventory_hostname == mysql_master and icinga_state == 'configuring'"
      action:
        module: "mysql_user"
        name: "icingaido"
        host: "%"
        password: "{{ icinga_ido_mysql_password }}"
        priv: "icingaido.*:ALL"

    - name: "initialize ido database"
      when: "inventory_hostname == mysql_master and icinga_state == 'configuring'"
      args:
        executable: "/bin/bash"
      shell:

        set -euf -o pipefail;

        mysql icingaido
          </usr/share/icinga2-ido-mysql/schema/mysql.sql;

    - set_fact:
        icinga_state: "running"
      when: "icinga_state == 'configuring'"

- hosts: "host"
  roles: [ "install-icinga" ]

# ex: et ts=2 filetype=yaml
