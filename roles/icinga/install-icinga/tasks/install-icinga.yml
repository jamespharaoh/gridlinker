---

- set_fact:
    icinga_state: "installing"
  when: "icinga_state is not defined"

- name: "install icinga packages"
  action:
    module: "apt"
    package: "{{ item }}"
  sudo: "yes"
  with_items:
    - "icinga2"
    - "icinga2-ido-mysql"

- name: "add ubuntu to nagios group"
  action:
    module: "user"
    name: "ubuntu"
    groups: "nagios"
    append: "yes"
  sudo: "yes"

- name: "disable icinga sysv init"
  sudo: "yes"
  register: "icinga_sysv_result"
  changed_when: "icinga_sysv_result.stdout != 'UNCHANGED'"
  shell:
    test -e /etc/init.d/icinga2 || { echo UNCHANGED; exit 0; };
    service icinga2 stop;
    rm -f /etc/init.d/icinga2 /etc/init.d/rc?.d/[KS]??icinga2;

- name: "install icinga2 upstart script"
  action:
    module: "template"
    src: "icinga-upstart"
    dest: "/etc/init/icinga2.conf"
  sudo: "yes"
  notify:
    - "reload upstart config"
    - "restart icinga2"

- meta: "flush_handlers"

- set_fact:
    icinga_state: "unconfigured"
  when: "icinga_state == 'installing'"

# ex: et ts=2 filetype=yaml
