---

- name: "configure icinga apt key"
  action:
    module: "apt_key"
    id: "4A132479423673E80ACCA85420EEDAFD36862847"
    keyserver: "keyserver.ubuntu.com"
  sudo: "yes"

- name: "configure icinga apt source"
  action:
    module: "apt_repository"
    repo: "deb {{ icinga_source }}/ubuntu trusty main"
    update_cache: "yes"
  sudo: "yes"

- name: "install icinga packages"
  action:
    module: "apt"
    package: "{{ item }}"
  sudo: "yes"
  with_items:
    - "icinga2"
    - "icinga2-ido-mysql"

- name: "add ubuntu to nagios group"
  action:
    module: "user"
    name: "ubuntu"
    groups: "nagios"
    append: "yes"
  sudo: "yes"

- name: "disable icinga sysv init"
  sudo: "yes"
  register: "icinga_sysv_result"
  changed_when: "icinga_sysv_result.stdout != 'UNCHANGED'"
  shell:
    test -e /etc/init.d/icinga2 || { echo UNCHANGED; exit 0; };
    service icinga2 stop;
    rm -f /etc/init.d/icinga2 /etc/init.d/rc?.d/[KS]??icinga2;

# ex: et ts=2 filetype=yaml
