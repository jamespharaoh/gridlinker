---

- name: "generate icinga.ticket_salt"
  when: "icinga_ticket_salt == 'no'"
  update_resource:

    icinga.ticket_salt: "{{ 20 | generate_random }}"

- name: "generate icinga.database_password"
  when: "icinga_database_password == 'no'"
  update_resource:

    icinga_database_password: "{{ 20 | generate_random }}"

- name: "create ido database"
  when: "icinga_database_type == 'mysql'"
  delegate_to: "{{ icinga_database_delegate }}"
  action:

    module: "mysql_db"
    name: "{{ icinga_database_name }}"

- name: "create ido user"
  when: "icinga_database_type == 'mysql'"
  delegate_to: "{{ icinga_database_delegate }}"
  action:

    module: "mysql_user"
    name: "{{ icinga_database_username }}"
    host: "%"
    password: "{{ icinga_database_password }}"
    priv: "{{ icinga_database_name }}.*:ALL"

- name: "initialize ido database"
  when: "
    icinga_database_type == 'mysql'
    and icinga_database_initialized == 'no'
  "
  delegate_to: "{{ icinga_database_delegate }}"
  args:

    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    mysql {{ icinga_database_name }}
      </usr/share/icinga2-ido-mysql/schema/mysql.sql;

    mysql {{ icinga_database_name }} --execute "
      ALTER TABLE icinga_instances
      ADD UNIQUE (instance_name);
    ";

- name: "set icinga.database_initialized to 'yes'"
  when: "icinga_database_type == 'mysql'"
  update_resource:

    icinga.database_initialized: "yes"

# ex: et ts=2 filetype=yaml
