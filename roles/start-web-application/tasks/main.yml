---

- name: "start web application"
  delegate_to: "{{ parent }}"
  action:
    module: "docker"
    name: "{{ cluster_name }}-{{ inventory_hostname }}"
    state: "running"
    image: "{{ docker_registry }}/{{ docker_images.web_application }}:{{ cluster.build }}"
    command: "/sbin/my_init"
    dns:
      - "{{ dns_servers.primary }}"
      - "{{ dns_servers.secondary }}"
    expose:
      - "80"
    ports:
      - "{{ hostvars [parent].private_address }}:{{ cluster.ports.web_application }}:80"
    tty: "True"
    stdin_open: "True"

- name: "wait for connection"
  delegate_to: "{{ parent }}"
  action:
    module: "wait_for"
    host: "{{ hostvars [parent].private_address }}"
    port: "{{ cluster.ports.web_application }}"
    state: "started"
    timeout: "60"

# ex: et ts=2 filetype=yaml
