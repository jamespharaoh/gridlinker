---

- name: "install web server packages"
  action:
    module: "apt"
    name: "{{ item }}"
  with_items:
   - "apache2"
   - "apachetop"
   - "libapache2-mod-fcgid"
   - "memcached"
   - "gettext"
   - "php5"
   - "php5-cli"
   - "php5-curl"
   - "php5-fpm"
   - "php5-gd"
   - "php5-mcrypt"
   - "php5-memcache"
   - "php5-memcached"
   - "php5-pgsql"
   - "php-gettext"

- name: "enable apache modules"
  action:
    module: "apache2_module"
    name: "{{ item }}"
  with_items:
   - "actions"
   - "alias"
   - "deflate"
   - "env"
   - "fcgid"
   - "mpm_event"
   - "proxy"
   - "proxy_fcgi"
   - "rewrite"
   - "ssl"
   - "headers"

- name: "create apache config"
  action:
    module: "template"
    src: "{{ item.template }}"
    dest: "{{ item.target }}"
  sudo: "yes"
  with_items:

    - template: "apache-php5-fpm-config"
      target: "/etc/apache2/conf-available/php5-fpm.conf"

    - template: "apache-mpm-event-config"
      target: "/etc/apache2/mods-available/mpm_event.conf"

- name: "enable apache php5 fpm config"
  command:
    a2enconf php5-fpm
  args:
    creates: "/etc/apache2/conf-enabled/php5-fpm.conf"
  sudo: "yes"

- name: "create service dir"
  action:
    module: "file"
    path: "/etc/service/{{ item }}"
    state: "directory"
  sudo: "yes"
  with_items:
    - "apache"
    - "memcached"
    - "php-fpm"

- name: "create service script"
  action:
    module: "template"
    src: "{{ item }}-service"
    dest: "/etc/service/{{ item }}/run"
    mode: "0755"
  sudo: "yes"
  with_items:
    - "apache"
    - "memcached"
    - "php-fpm"

- name: "create php5 fpm www config"
  action:
    module: "template"
    src: "php5-fpm-www-config"
    dest: "/etc/php5/fpm/pool.d/www.conf"
  sudo: "yes"

- name: "create datingnode config"
  action:
    module: "template"
    src: "datingnode-config"
    dest: "/var/www/datingnode-config.json"
  sudo: "yes"

# ex: et ts=2 filetype=yaml
