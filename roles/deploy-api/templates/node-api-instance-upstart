description "wistla api instance"

instance $WISTLA_API_INDEX

stop on runlevel [!2345]

respawn
respawn limit unlimited

env HOME=/home/ubuntu

script

	cd /home/ubuntu/wistla-api

	setuid ubuntu \
	mkdir --parents /shared/log

	setuid ubuntu \
	touch /shared/log/wistla-api.log

	exec >> /shared/log/wistla-api.log
	exec 2>> /shared/log/wistla-api.log

	exec setuid ubuntu \
{% if dev_debug | default ('no') == 'yes' %}
	node-debug \
	--debug-brk=0 \
{% else %}
	stdbuf -oL -eL \
	node \
	--trace_gc \
	--expose_gc \
	--min_semi_space_size={{ 4 }} \
	--max_semi_space_size={{ 32 }} \
	--max_old_space_size={{ (node_memory.api | int) - 128 }} \
	--max_executable_size={{ 32 }} \
{% endif %}
	server.js

end script

post-stop exec sleep 2
