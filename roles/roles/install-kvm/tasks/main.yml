---

- name: "create config dir"
  become: "yes"
  action:

    module: "file"
    path: "/etc/rocket"
    state: "directory"

- name: "install kvm packages"
  with_items:

    - "libvirt-bin"
    - "qemu"
    - "virtinst"

  become: "yes"
  action:

    module: "apt"
    package: "{{ item }}"
    state: "present"

- name: "create libvirt-network-public.xml"
  become: "yes"
  action:

    module: "template"
    dest: "/etc/rocket/libvirt-network-public.xml"
    src: "install-kvm-network-public"

- name: "create libvirt-network-private.xml"
  action:
    module: "template"
    src: "install-kvm-network-private"
    dest: "/etc/rocket/libvirt-network-private.xml"
  sudo: "yes"
  tags: "kvm"

- name: "configure libvirt network public"
  shell: >
    virsh net-define /etc/rocket/libvirt-network-public.xml;
    virsh net-autostart public;
    virsh net-start public
  args:
    creates: "/etc/libvirt/qemu/networks/public.xml"
  tags: "kvm"

- name: "configure libvirt network private"
  shell: >
    virsh net-define /etc/rocket/libvirt-network-private.xml;
    virsh net-autostart private;
    virsh net-start private
  args:
    creates: "/etc/libvirt/qemu/networks/private.xml"
  tags: "kvm"

- name: "configure libvirt network private"
  shell: >
    virsh net-destroy default;
    virsh net-undefine default
  args:
    removes: "/etc/libvirt/qemu/networks/default.xml"
  tags: "kvm"
