---

- name: "install openvpn packages"
  with_items:

    - "openvpn"

  become: "yes"
  action:

    module: "apt"
    name: "{{ item }}"

- name: "copy openvpn credentials"
  with_items:

    - source: "{{ openvpn.ca_certificate }}"
      target: "/etc/openvpn/rocket-ca.cert"
      mode: "0644"

    - source: "{{ openvpn.certificate }}"
      target: "/etc/openvpn/{{ identity.name }}.cert"
      mode: "0644"

    - source: "{{ openvpn.private_key }}"
      target: "/etc/openvpn/{{ identity.name }}.key"
      mode: "0600"

  notify: "restart openvpn"
  become: "yes"
  action:

    module: "copy"
    dest: "{{ item.target }}"
    content: "{{ lookup ('etcd', item.source) }}"
    mode: "{{ item.mode }}"

- name: "create openvpn config"
  with_items:
  
    - template: "openvpn-config"
      target: "/etc/openvpn/{{ identity.name }}.conf"

  notify: "restart openvpn"
  become: "yes"
  action:

    module: "template"
    dest: "{{ item.target }}"
    src: "{{ item.template }}"

- name: "create openvpn dhparams"
  args:

    creates: "/etc/openvpn/dh1024.pem"

  shell: "openssl dhparam -out /etc/openvpn/dh1024.pem 1024"

- meta: "flush_handlers"

# ex: et ts=2 filetype=yaml
