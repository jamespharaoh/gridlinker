---

- name: "install system packages"
  action:
    module: "apt"
    state: "present"
    name: "{{ item }}"
  sudo: "yes"
  sudo_user: "root"
  with_items: "load_install_packages"

- name: "install nginx config"
  action:
    module: "template"
    src: "nginx-config"
    dest: "/etc/nginx/nginx.conf"
  sudo: "yes"
  sudo_user: "root"

- name: "deploy projects"
  delegate_to: "localhost"
  shell:

    set -e;

    rsync
      --archive
      --delete
      --itemize-changes
      {{ deployment_home }}/{{ item }}/
      /var/lib/lxc/{{ deployment }}-{{ inventory_hostname }}/rootfs/home/ubuntu/{{ item }}/
      --exclude /config/config.local.js
      --include /config
      --include /config.js
      --include /dist
      --include /favicon.ico
      --include /index.html
      --include /jspm_packages
      --include /styles
      --exclude '/*';

  sudo: "yes"
  sudo_user: "root"
  register: "deploy_output"
  changed_when: "deploy_output.stdout != ''"
  tags: "quick"
  with_items:
    - "wistla-admin"

- name: "link to upstream config"
  action:
    module: "file"
    path: "{{ item.link }}"
    state: "link"
    src: "{{ item.source }}"
    force: "yes"
  with_items:

    - link: "/etc/nginx/upstream.conf"
      source: "/config/nginx-upstream.conf"

    - link: "/home/ubuntu/wistla-admin/config/config.local.js"
      source: "/config/wistla-admin-config.local.js"

# ex: et ts=2 filetype=yaml
