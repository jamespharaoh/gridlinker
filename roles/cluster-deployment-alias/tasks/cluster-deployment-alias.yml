---

- name: "create deployment alias directory"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ cluster_deployment_alias_name }}"
    state: "directory"

- name: "checkout deployment alias projects from git"
  shell:

    set -e;

    cd {{ vagrant_home }}/{{ cluster_deployment_alias_name }};

    git clone
      git@github.com:/wistla/{{ item.name }}
      --branch {{ item.branch }};

  args:
    creates: "{{ vagrant_home }}/{{ cluster_deployment_alias_name }}/{{ item.name }}"
  with_items: "cluster_deployment_alias_checkouts"

- name: "run project build steps"
  shell: "{{ item.build_steps | default ([ 'true' ]) | join (' && ') }}"
  args:
    chdir: "{{ vagrant_home }}/{{ cluster_deployment_alias_name }}/{{ item.name }}"
  tags: "build"
  with_items: "cluster_deployment_alias_checkouts"

- name: "create config directories"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ cluster_deployment_alias_name }}/{{ item }}"
    state: "directory"
  with_items: "cluster_deployment_alias_config_directories"

- name: "create deployment alias shared directory"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ cluster_deployment_alias_name }}/shared"
    state: "directory"

- name: "create deployment alias shared directories"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ cluster_deployment_alias_name }}/shared/{{ item }}"
    state: "directory"
  with_items: "cluster_deployment_alias_shared_directories"

- name: "create deployment alias shared links"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ cluster_deployment_alias_name }}/shared/{{ item.link }}"
    state: "link"
    src: "{{ item.target }}"
  with_items: "cluster_deployment_alias_shared_links"

- name: "create deployment alias config files"
  action:
    module: "template"
    src: "{{ item.template }}"
    dest: "{{ vagrant_home }}/{{ cluster_deployment_alias_name }}/{{ item.target }}"
  with_items: "cluster_deployment_alias_config_templates"

- name: "copy deployment alias config files"
  action:
    module: "copy"
    src: "{{ item.source }}"
    dest: "{{ vagrant_home }}/{{ cluster_deployment_alias_name }}/{{ item.target }}"
    mode: "{{ item.mode }}"
  with_items: "cluster_deployment_alias_config_files"

- name: "create deployment alias links to config files"
  action:
    module: "file"
    path: "{{ vagrant_home }}/{{ cluster_deployment_alias_name }}/{{ item.target }}"
    src: "{{ item.source }}"
    state: "link"
    force: "yes"
  with_items: "cluster_deployment_alias_config_links"

# ex: et ts=2 filetype=yaml
