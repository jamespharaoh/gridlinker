---

- set_fact_dynamic:
    mysql.state: "installing"
  when: "mysql_state is not defined"

- name: "install mysql packages"
  action:
    module: "apt"
    name: "{{ item }}"
  sudo: "yes"
  with_items:

    - "mysql-server-5.5"
    - "python-mysqldb"

- name: "install mysql config"
  sudo: "yes"
  notify: "restart mysql"
  action:

    module: "template"
    src: "{{ item.template }}"
    dest: "{{ item.target }}"

  with_items:

    - template: "mysql-global-config"
      target: "/etc/mysql/my.cnf"

- name: "create mysql root user"
  when: "inventory_hostname == mysql_master and mysql_state == 'installing'"
  action:

    module: "mysql_user"
    name: "root"
    password: "{{ mysql_root_password }}"
    priv: "*.*:ALL,GRANT"

- name: "install mysql user config"
  when: "mysql_state == 'installing'"
  sudo: "yes"
  action:

    module: "template"
    src: "mysql-user-config"
    dest: "{{ item.home }}/.my.cnf"
    owner: "{{ item.user }}"
    group: "{{ item.user }}"
    mode: "0600"

  with_items:

    - user: "root"
      home: "/root"

    - user: "ubuntu"
      home: "/home/ubuntu"

- name: "disable mysql sysv init"
  sudo: "yes"
  register: "mysql_sysv_result"
  changed_when: "mysql_sysv_result.stdout != 'UNCHANGED'"
  shell:
    test -e /etc/init.d/mysql || { echo UNCHANGED; exit 0; };
    service mysql stop;
    rm -f /etc/init.d/mysql /etc/init.d/rc?.d/[KS]??mysql;

- name: "write mysql upstart config"
  action:
    module: "template"
    src: "mysql-upstart"
    dest: "/etc/init/mysql.conf"
  sudo: "yes"
  notify: [ "reload upstart config", "restart mysql" ]

- set_fact_dynamic:
    mysql.state: "unconfigured"
  when: "mysql_state == 'installing'"

- meta: "flush_handlers"

# ex: et ts=2 filetype=yaml
