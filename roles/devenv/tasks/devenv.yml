---

- name: "checkout projects from git"
  shell:

    set -e;

    cd {{ deployment_home }};

    git clone
      git@github.com:/wistla/{{ item.name }}
      --branch {{ item.branch }};

  args:
    creates: "{{ deployment_home }}/{{ item.name }}"
  sudo: "yes"
  sudo_user: "{{ deployment_user }}"
  with_items: "devenv_checkouts"
  when: "deployment_mode == 'vagrant'"

- name: "run build steps"
  shell: "{{ item.build_steps | default (['true']) | join (' && ') }}"
  args:
    chdir: "{{ deployment_home }}/{{ item.name }}"
    creates: "{{ deployment_home }}/{{ item }}/node_modules"
  sudo: "yes"
  sudo_user: "{{ deployment_user }}"
  with_items: "devenv_checkouts"
  tags: "build"

- name: "create git pre-commit hooks"
  action:
    module: "template"
    src: "devenv-git-hook-pre-commit"
    dest: "{{ deployment_home }}/{{ item.name }}/.git/hooks/pre-commit"
    mode: "0755"
  sudo: "yes"
  sudo_user: "{{ deployment_user }}"
  with_items: "devenv_checkouts"
  when: "deployment_mode == 'vagrant'"

- name: "create git post-checkout hooks"
  action:
    module: "template"
    src: "devenv-git-hook-post-checkout"
    dest: "{{ deployment_home }}/{{ item.name }}/.git/hooks/post-checkout"
    mode: "0755"
  sudo: "yes"
  sudo_user: "{{ deployment_user }}"
  with_items: "devenv_checkouts"
  when: "deployment_mode == 'vagrant'"

- name: "create shared directories"
  action:
    module: "file"
    path: "{{ deployment_home }}/{{ item }}"
    state: "directory"
  sudo: "yes"
  sudo_user: "{{ deployment_user }}"
  with_items: "devenv_shared_directories"

- name: "create config directories"
  action:
    module: "file"
    path: "{{ deployment_home }}/{{ item }}"
    state: "directory"
  sudo: "yes"
  sudo_user: "{{ deployment_user }}"
  with_items: "devenv_config_directories"

- name: "create config files"
  action:
    module: "template"
    src: "{{ item.template }}"
    dest: "{{ deployment_home }}/config/{{ item.type }}/{{ item.target }}"
  sudo: "yes"
  sudo_user: "{{ deployment_user }}"
  with_items: "devenv_config_templates"

- name: "stat override config files"
  action:
    module: "stat"
    path: "{{ deployment_home }}/{{ item.target }}"
  with_items: "devenv_override_templates"
  register: "devenv_stat_override_templates_result"

- name: "create override config templates"
  action:
    module: "template"
    dest: "{{ deployment_home }}/{{ item.1.target }}"
    src: "{{ item.1.template }}"
  with_indexed_items: "devenv_override_templates"
  when: "not devenv_stat_override_templates_result.results [item.0].stat.exists"

- name: "copy config files"
  action:
    module: "copy"
    src: "{{ item.source }}"
    dest: "{{ deployment_home }}/config/{{ item.type }}/{{ item.target }}"
    mode: "0644"
  sudo: "yes"
  sudo_user: "{{ deployment_user }}"
  with_items: "devenv_config_files"

- name: "copy config secrets"
  action:
    module: "copy"
    src: "{{ item.source }}"
    dest: "{{ deployment_home }}/config/{{ item.type }}/{{ item.target }}"
    mode: "0600"
  sudo: "yes"
  sudo_user: "{{ deployment_user }}"
  when: "'dev' in secrets"
  with_items: "devenv_config_secrets"

- name: "create links to config files"
  action:
    module: "file"
    path: "{{ deployment_home }}/{{ item.dest }}"
    src: "{{ item.src }}"
    state: "link"
    force: "yes"
  sudo: "yes"
  sudo_user: "{{ deployment_user }}"
  with_items: "devenv_config_links"

- name: "create deployment name link"
  action:
    module: "file"
    path: "{{ deployment_home }}/{{ deployment }}"
    state: "link"
    src: "."
  sudo: "yes"
  sudo_user: "{{ deployment_user }}"
  when: "deployment_mode == 'vagrant'"

- name: "create bridge network interface"
  action:
    module: "template"
    src: "devenv-bridge-interface"
    dest: "/etc/network/interfaces.d/{{ deployment.bridge_name }}.cfg"
  sudo: "yes"
  register: "devenv_bridge_create_result"

- name: "stop network bridge"
  shell:

    set -e

    if ! ifquery --state {{ deployment.bridge_name }} >/dev/null; then
      echo "UNCHANGED";
      exit;
    fi

    ifdown {{ deployment.bridge_name }};

  sudo: "yes"
  when: "devenv_bridge_create_result | changed"
  register: "devenv_bridge_stop_result"
  changed_when: "devenv_bridge_stop_result.stdout != 'UNCHANGED'"

- name: "start network bridge"
  shell:

    set -e

    if ifquery --state {{ deployment.bridge_name }} >/dev/null; then
      echo "UNCHANGED";
      exit;
    fi

    ifup {{ deployment.bridge_name }};

  sudo: "yes"
  sudo_user: "root"
  register: "devenv_bridge_start_result"
  changed_when: "devenv_bridge_start_result.stdout != 'UNCHANGED'"

# ex: et ts=2 filetype=yaml
