---

- name: "remove postfix"
  with_items:

    - "postfix"

  become: "yes"
  action:

    module: "apt"
    name: "{{ item }}"
    state: "absent"
    purge: "yes"

- name: "configure nullmailer"
  become: "yes"
  with_items:

    - question: "shared/mailname"
      value: "{{ deployment.email_domain }}"
      type: "string"

    - question: "nullmailer/relayhost"
      value: "10.255.255.10"
      type: "string"

    - question: "nullmailer/defaultdomain"
      value: "{{ deployment.email_domain }}"
      type: "string"

    - question: "nullmailer/adminaddr"
      value: ""
      type: "string"

  action:

    module: "debconf"
    name: "nullmailer"
    question: "{{ item.question }}"
    value: "{{ item.value }}"
    vtype: "{{ item.type }}"

# TODO mailname needs to be configured later

- name: "create directories"
  with_items:

    - directory: "/etc/nullmailer"

  become: "yes"
  action:

    module: "file"
    path: "{{ item.directory }}"
    state: "directory"

- name: "configure mailname"
  with_items:

    - target: "/etc/mailname"
      content: "{{ deployment.email_domain + '\n' }}"

    - target: "/etc/nullmailer/defaultdomain"
      content: "{{ deployment.email_domain + '\n' }}"

  become: "yes"
  action:

    module: "copy"
    dest: "{{ item.target }}"
    content: "{{ item.content }}"

- name: "install nullmailer"
  with_items:

    - "nullmailer"

  become: "yes"
  action:

    module: "apt"
    name: "{{ item }}"

# ex: et ts=2 filetype=yaml
