---

- name: "deploy projects"
  tags: "quick"
  with_items: "{{ node_load_deploy_projects }}"
  when: "
    (
      'when' not in item
    ) or (
      deployment [item.when] == 'yes'
    )
  "
  changed_when: "deploy_output.stdout != ''"
  register: "deploy_output"
  delegate_to: "localhost"
  args:

    executable: "/bin/bash"

  become: "yes"
  shell:

    set -euf -o pipefail;

    rsync
      --archive
      --delete
      --itemize-changes
      {{ deployment_home }}/{{ item.name }}/
      /var/lib/lxc/{{ inventory_hostname }}/rootfs/home/ubuntu/{{ item.name }}/
      {{ item.filters | join (' ') }};

- name: "link to upstream config"
  with_items: "{{ node_load_config_links }}"
  action:

    module: "file"
    path: "{{ item.link }}"
    state: "link"
    src: "{{ item.source }}"
    force: "yes"

- name: "install special robots.txt"
  become: "yes"
  action:

    module: "copy"
    dest: "/etc/nginx/robots-txt-assets"
    src: "robots-txt-assets"

# ex: et ts=2 filetype=yaml
