#!/bin/bash

set -e

# always run from vagrant machine

if ! test "$HOSTNAME" = "wistla-dev"; then
	echo "This command must be run from inside vagrant" >&2
	echo "Please run 'vagrant ssh' and try again" >&2
	exit 1
fi

# always run as root

if test "$UID" != "0"; then
	exec sudo "$0" "$@"
fi

# load ansible environment

cd /home/vagrant/wistla-devops

source ansible/hacking/env-setup >/dev/null

# fix config

ansible-playbook \
	--inventory-file inventory \
	--extra-vars @config \
	--limit vagrant \
	fix-config.yml

# run ansible-playbook

exec ansible-playbook \
	--inventory-file inventory \
	--extra-vars @config \
	site.yml \
	"${@}"
