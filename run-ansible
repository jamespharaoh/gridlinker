#!/bin/bash

set -e

# always run from vagrant machine

if ! test "$HOSTNAME" = "wistla-dev"; then
	echo "This command must be run from inside vagrant" >&2
	echo "Please run 'vagrant ssh' and try again" >&2
	exit 1
fi

# always run as root

if test "$UID" != "0"; then
	exec sudo "$0" "$@"
fi

# load ansible environment

cd /home/vagrant/wistla-devops

source ansible/hacking/env-setup >/dev/null

# fix config

ansible-playbook \
	--inventory-file inventory \
	--extra-vars @config \
	--limit vagrant \
	fix-config.yml

if ! test -f accounts; then
	cat >accounts <<-END
		---
		amazon_accounts:
		  production:
		    access_key: ""
		    secret_key: ""
		  staging:
		    access_key: ""
		    secret_key: ""
		  test:
		    access_key: ""
		    secret_key: ""
		  operations:
		    access_key: ""
		    secret_key: ""
	END
	chown vagrant:vagrant accounts
fi

# run ansible-playbook

exec ansible-playbook \
	--inventory-file inventory \
	--extra-vars @config \
	--extra-vars @accounts \
	"${@}"
