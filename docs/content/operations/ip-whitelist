Short-title: IP whitelist
Long-title: Wistla IP whitelist
Description: IP whitelist for access to internal APIs

This page describes the IP whitelist which controls access to sensitive internal
APIs, which have the path prefix `/TEST`. The principal use for this is to load
databasets into the test environments.

## Updating the whitelist

The whitelist is stored in the etcd operations database, in a the gridlinker
resource for each cluster. In the typical case, you will need to update the
whitelist for the test cluster:

```
./wistla-devops resource edit --name cluster/test
```

The whitelist looks like this:

```
cluster:

  whitelist_ips:

    - ip: "81.111.95.100"
      name: "Elayne Schulz"

    - ip: "109.224.246.196"
      name: "Elayne Schulz"

    - ip: "82.7.187.166"
      name: "Elayne Schulz"
```

The name is not used but it is useful to track where an IP address has come from
in order to maintain the list.

Once this has been updated, you should redeploy the nginx configuration to the
cluster:

```
./run-ansible "playbooks/cluster-app.yml" \
    --limit "cluster-test" \
    --tags "cluster-app-nginx
```

## Internal implementation

This is implemented in the level-1 nginx config, in [cluster-app-nginx-config]
(https://github.com/wistla/wistla-devops/blob/master/playbooks/cluster/cluster-app-nginx/templates/cluster-app-nginx-config#L3):

```
{% set restrictions %}
{% for whitelist_ip in cluster.whitelist_ips %}
			allow {{ whitelist_ip.ip }}; # {{ whitelist_ip.name }}
{% endfor %}
			deny all;
{% endset %}
```

This is then included into the virtual host configurations:

```
location /TEST {

    proxy_pass http://deployment-{{ target }};
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host "api.{{ deployment.main_domain }}";
    proxy_set_header X-Wistla-Entry-Region "{{ region_code }}";

    {{ restrictions }}

}
```
