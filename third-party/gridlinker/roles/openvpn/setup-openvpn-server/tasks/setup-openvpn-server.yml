---

- name: "create openvpn server directories"
  action:
    module: "file"
    dest: "{{ item.directory }}"
    state: "directory"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  sudo: "yes"
  notify: "restart openvpn"
  with_items: "openvpn_config_directories"

- name: "write openvpn server config"
  action:
    module: "template"
    dest: "{{ item.target }}"
    src: "{{ item.template }}"
    mode: "{{ item.mode }}"
  sudo: "yes"
  notify: "restart openvpn"
  with_items: "openvpn_config_templates"

- name: "write openvpn server security"
  action:
    module: "copy"
    dest: "{{ item.target }}"
    content: "{{ lookup ('etcd', item.source) }}"
    mode: "{{ item.mode }}"
  sudo: "yes"
  notify: "restart openvpn"
  with_items: "openvpn_security_files"

- name: "create dh params"
  args:
    creates: "/etc/openvpn/{{ openvpn_server_name }}-dh.pem"
    executable: "/bin/bash"
  shell: "openssl dhparam -out /etc/openvpn/{{ openvpn_server_name }}-dh.pem 1024"
  notify: "restart openvpn"
  sudo: "yes"

- meta: "flush_handlers"

# ex: et ts=2 filetype=yaml
