---

- name: "unpack build"
  connection: "local"
  environment:

    build_source: "{{ [
      deployment_home,
      '/builds/backups/',
      build_deployment_name,
      '-',
      node_type,
      '-',
      build_id,
      '.tar.gz',
    ] | join }}"

    build_target: "/var/lib/lxc/{{ inventory_hostname }}/rootfs"

  args:

    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    if test -e "$build_target"; then

      btrfs subvolume delete "$build_target";

      sleep 2;

    fi;

    btrfs subvolume create "$build_target";

    {
      zbackup restore "$build_source.temp"
        --password-file "/vagrant/secret/wistla-build-secret"
        --silent;
    } | {
      sudo tar
        --extract
        --directory "$build_source"
        ".";
    };

# ex: et ts=2 filetype=yaml
