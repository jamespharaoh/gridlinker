{{ ansible_warning ['//'] }}

{% if 'jenkins-' in deployment_name %}
{% set deployment_security = lookup ('file',
	HOME + '/security/deployments/' + deployment_name
) | from_yaml %}
{% else %}
{% set deployment_security = lookup ('file',
	HOME + '/security/deployments/dev-' + deployment_name
) | from_yaml %}
{% endif %}

var ROOT = process.cwd ();
var config = require(ROOT + '/config/config.global');

// public urls
config.adminUrl = 'https://{{ deployment.admin_domain }}';
config.apiUrl = 'https://{{ deployment.api_domain }}';
config.assetsUrl = 'https://{{ deployment.assets_domain }}';
config.shortUrl = 'https://{{ deployment.short_domain }}';
config.webUrl = 'https://{{ deployment.web_domain }}';

// test urls
config.adminTest = 'http://{{ deployment.admin_domain }}';
config.apiTest = 'http://{{ deployment.api_domain }}';
config.assetsTest = 'http://{{ deployment.assets_domain }}';
config.shortTest = 'http://{{ deployment.short_domain }}';
config.webTest = 'http://{{ deployment.web_domain }}';

// email
config.emailDomain = '{{ deployment.email_domain }}';

// Database.
config.dbUrl = 'mongodb://{{ deployment_name }}-mongo-0:27017/wistla';
config.dbOptions = {
	replSet: {
		rs_name: 'wistla-1-1',
	},
	db: {
		w: 1,
		j: false,
	},
};

// message exchange
config.amqpOptions = {
	url: 'amqp://{{ deployment_name }}-rabbit-0', // TODO deprecate this
	urls: [
{% for rabbit_name in groups ['node-rabbit-host'] %}
{% set rabbit_host = hostvars [rabbit_name] %}
{% if rabbit_host.node_index < dev_node_count.rabbit | int %}
		'amqp://{{ rabbit_name }}',
{% endif %}
{% endfor %}
	],
};

// CORS
config.CORS = {
	origins: [

		// public urls
		config.adminUrl,
		config.apiUrl,
		config.assetsUrl,
		config.shortUrl,
		config.webUrl,

		// test urls
		config.adminTest,
		config.apiTest,
		config.assetsTest,
		config.shortTest,
		config.webTest,

	],
	credentials: true
};

// blob storage
{% if dev_api_use_s3 == 'yes' %}
config.blobMode = 'amazon';
{% else %}
config.blobMode = 'local';
{% endif %}

config.blobAmazon = {
	accessKey: '{{ deployment_security.api.access_key_id }}',
	secretKey: '{{ deployment_security.api.secret_access_key }}',
{% if 'jenkins-' in deployment_name %}
	bucketName: 'wistla-dev-{{ deployment_name }}-blobs',
{% else %}
	bucketName: 'wistla-{{ deployment_name }}-blobs',
{% endif %}
	bucketPrefix: ''
};

// mailchimp
{% if 'dev' in third_parties %}
config.mailchimp = {
	listId: '{{ third_parties.dev.mailchimp_unique_id }}',
	apiKey: '{{ third_parties.dev.mailchimp_api_key }}',
};
{% else %}
config.mailchimp = {
	listId: '',
	apiKey: '',
};
{% endif %}

// test data loader
config.loadingData = {
	email: '350477707572-gcc5pqssbhl7n29pbcs923havgbddh1e@developer.gserviceaccount.com',
	keyFile: ROOT + '/config/google-service-account.key',
{% if 'dev' in third_parties %}
        cryptoKey: '{{ third_parties.dev.google_maps_key }}'
{% else %}
		cryptoKey: ''
{% endif %}
};

// Turn on longStackTraces in dev by default.
config.longStackTraces = true;

// apple push notifications
config.applePush = {
{% if dev_apple_push_notifications_enabled | default ('no') == 'yes' %}
	enabled: true,
	caCertFile: ROOT + '/config/apple-ca.cert',
	certFile: ROOT + '/config/apple-push.cert',
	keyFile: ROOT + '/config/apple-push.key',
	production: {{ 'true' if dev_apple_push_notifications_production == 'yes' else 'false' }},
{% else %}
	enabled: false,
{% endif %}
};

// Deep link url scheme for use in sending out emails.
{% if 'dev' in third_parties %}
config.urlScheme = '{{ third_parties.dev.url_scheme }}';
{% else %}
config.urlScheme = '';
{% endif %}

// Analytics


if (!config.analytics || typeof config.analytics !== 'object') {
	config.analytics = {};
}

if (!config.analytics.provider || typeof config.analytics.provider !== 'object') {
	config.analytics.provider = {};
}

if (!config.analytics.provider.amplitude || typeof config.analytics.provider.amplitude !== 'object') {
	config.analytics.provider.amplitude = {};
}

if (!config.analytics.provider.aws || typeof config.analytics.provider.aws !== 'object') {
	config.analytics.provider.aws = {};
}

if (!config.analytics.provider.google || typeof config.analytics.provider.google !== 'object') {
	config.analytics.provider.google = {};
}

{% if 'dev' in third_parties %}
config.analytics.provider.amplitude.apiKey = '{{ third_parties.dev.analytics_amplitude_key_api }}';
config.analytics.provider.amplitude.secretKey = '{{ third_parties.dev.analytics_amplitude_key_secret }}';

config.analytics.provider.aws.appId = '{{ third_parties.dev.analytics_aws_id_app }}';
config.analytics.provider.aws.appName = '{{ third_parties.dev.analytics_aws_app_name }}';
config.analytics.provider.aws.identityPoolId = '{{ third_parties.dev.analytics_aws_id_identity_pool }}';
config.analytics.provider.aws.region = '{{ third_parties.dev.analytics_aws_region }}';

config.analytics.provider.google.trackerId = '{{ third_parties.dev.analytics_google_id_tracker }}';

{% else %}
config.analytics.provider.amplitude.apiKey = '';
config.analytics.provider.amplitude.secretKey = '';

config.analytics.provider.aws.appId = '';
config.analytics.provider.aws.appName = '';
config.analytics.provider.aws.identityPoolId = '';
config.analytics.provider.aws.region = '';

config.analytics.provider.google.trackerId = '';

{% endif %}

if (!config.gcm || typeof config.gcm !== 'object') {
    config.gcm = {};
}
{% if 'dev' in third_parties %}
config.gcm.enabled = true;
config.gcm.apiKey = '{{ third_parties.dev.google_cloud_messaging_api_key }}';
config.gcm.senderId = '{{ third_parties.dev.google_cloud_messaging_sender_id }}';
config.gcm.appName = '{{ third_parties.dev.google_cloud_messaging_app_name }}';
{% else %}
config.gcm.enabled = false;
config.gcm.apiKey = '';
config.gcm.senderId = '';
config.gcm.appName = '';
{% endif %}

// facebook app to use
{% if 'dev' in third_parties %}
config.authentication.facebook.appToUse = '{{ third_parties.dev.facebook_app_to_use }}';
{% else %}
config.authentication.facebook.appToUse = 'wistlaDev';
{% endif %}

// facebook app configuration options
config.authentication.facebook.apps = {
{% for key, cluster_name in {
	'wistla': 'production',
	'wistlaStaging': 'staging',
	'wistlaTest': 'test',
	'wistlaDev': 'dev',
}.items () %}
{% if 'dev' in third_parties %}
	{{ key }}: {
		appId: '{{ third_parties [cluster_name].facebook_app_id }}',
		appSecret: '{{ third_parties [cluster_name].facebook_app_secret }}',
		appAccessToken: '{{ third_parties [cluster_name].facebook_app_access_token }}'
	},
{% else %}
	{{ key }}: {
		appId: '',
		appSecret: '',
		appAccessToken: ''
	},
{% endif %}
{% endfor %}
};

// monitoring email address (for email activation warnings)
config.monitoringEmailAddress =
	'Wistla Operations <notifications.production.warning@wistla.com>';
// content email address (for new wistls and wistl warnings)
{% if 'dev' in third_parties %}
config.contentEmailAddress = '{{ third_parties.dev.content_email }}';
{% else %}
config.contentEmailAddress = '';
{% endif %}

module.exports = config;

// ex: noet ts=4 filetype=javascript
