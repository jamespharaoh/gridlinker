---

- hosts: "localhost"
  tasks:

    - name: "warning"
      when: "deployment_mode == 'vagrant'"
      pause:

        prompt: "WARNING - this will delete ALMOST ALL files not managed by git"

    - name: "remove project links"
      with_items: "{{ devenv_checkouts | flatten_hash ('project_links') }}"
      become: "yes"
      args:

        executable: "/bin/bash"

      shell:

        set -euf -o pipefail;

        link="{{ [
          deployment_home,
          item.outer.name,
          item.project_links.link,
        ] | join ('/') }}";

        overlay="{{ [
          deployment_home,
          item.outer.name,
          item.project_links.overlay,
        ] | join ('/') }}";

        target="{{ item.project_links.target }}";

        if {
          cut -d' ' -f 2 </proc/mounts
            | grep -x "$link";
        }; then
          umount "$link";
        fi;

        if test -d "$overlay"; then
          rm -rf "$overlay";
        fi;

        if test -h "$link"; then
          rm "$link";
        fi;

    - name: "clean checked out projects"
      with_items: "{{
        (
          devenv_checkouts
            | rejectattr ('name', 'equalto', 'wistla-devops')
            | list
        ) | union (
          devenv_checkouts
            | selectattr ('name', 'equalto', 'wistla-devops')
            | list
        )
      }}"
      args:

        executable: "/bin/bash"

      shell:

        set -euf -o pipefail;

        if ! test -d "{{ deployment_home }}/{{ item.name }}"; then
          exit 0;
        fi;

        cd "{{ deployment_home }}/{{ item.name }}";

        git clean -xdf
          {{
            item.configs
            | default ([])
            | prepend_list ('--exclude ')
            | join (' ')
          }};

# ex: et ts=2 filetype=yaml
