{{ ansible_warning ['//'] }}

{% set cluster_deployment_security = lookup ('file',
	HOME + '/security/deployments/' + cluster_deployment_name
) | from_yaml %}

var ROOT = process.cwd ();
var config = require(ROOT + '/config/config.global');

// public urls
config.adminUrl = 'https://{{ cluster_deployment_alias.admin_domain }}';
config.apiUrl = 'https://{{ cluster_deployment_alias.api_domain }}';
config.assetsUrl = 'https://{{ cluster_deployment_alias.assets_domain }}';
config.shortUrl = 'https://{{ cluster_deployment_alias.short_domain }}';
config.webUrl = 'https://{{ cluster_deployment_alias.web_domain }}';

// test urls
config.adminTest = 'http://{{ cluster_deployment_alias.admin_domain }}';
config.apiTest = 'http://{{ cluster_deployment.api_domain }}';
config.assetsTest = 'http://{{ cluster_deployment_alias.assets_domain }}';
config.shortTest = 'http://{{ cluster_deployment.short_domain }}';
config.webTest = 'http://{{ cluster_deployment.web_domain }}';

// email
config.emailDomain = '{{ cluster_deployment.email_domain }}';

// Database.
{% if cluster_name in [ 'staging' ] %}
config.dbUrl = [
	'mongodb://{{ cluster_deployment_alias.name }}-mongo-a-4:27017/wistla',
	'mongodb://{{ cluster_deployment_alias.name }}-mongo-b-4:27017/wistla',
	'mongodb://{{ cluster_deployment_alias.name }}-mongo-c-4:27017/wistla',
].join (',');
config.dbOptions = {
	replSet: {
		rs_name: 'wistla-1-1',
	},
	db: {
		w: 2,
		j: false,
	},
};
{% else %}
config.dbUrl = 'mongodb://{{ cluster_deployment_alias.name }}-mongo-a-4:27017/wistla';
config.dbOptions = {
	replSet: {
		rs_name: 'wistla-1-1',
	},
	db: {
		w: 1,
		j: false,
	},
};
{% endif %}

// message exchange
config.amqpOptions = {
	url: 'amqp://{{ cluster_deployment_alias.name }}-rabbit-{{ instance_zone }}-{{ instance_index }}',
};

// CORS
config.CORS = {
	origins: [

		'https://{{ cluster_deployment.admin_domain }}',
		'https://{{ cluster_deployment.api_domain }}',
		'https://{{ cluster_deployment.main_domain }}',
		'https://{{ cluster_deployment.short_domain }}',
		'https://{{ cluster_deployment.web_domain }}',

{% if cluster_deployment.type == 'alias' %}
		'https://{{ cluster_deployment_alias.admin_domain }}',
		'https://{{ cluster_deployment_alias.api_domain }}',
		'https://{{ cluster_deployment_alias.main_domain }}',
		'https://{{ cluster_deployment_alias.short_domain }}',
		'https://{{ cluster_deployment_alias.web_domain }}',
{% endif %}

	],
	credentials: true
};

{% if cluster_deployment_alias.blob_storage == 'amazon' %}

// amazon s3 blob storage
config.blobMode = 'amazon';
config.blobAmazon = {
	accessKey: '{{ cluster_deployment_security.api.access_key_id }}',
	secretKey: '{{ cluster_deployment_security.api.secret_access_key }}',
	bucketName: 'wistla-{{ cluster_deployment_alias.name }}-blobs',
	bucketPrefix: ''
};

{% else %}

// local blob storage
config.blobMode = 'local';

{% endif %}

// mailchimp
config.mailchimp = {
	listId: '{{ third_parties [cluster_name].mailchimp_unique_id }}',
	apiKey: '{{ third_parties [cluster_name].mailchimp_api_key }}',
};

// test data loader
config.loadingData = {
	email: '350477707572-gcc5pqssbhl7n29pbcs923havgbddh1e@developer.gserviceaccount.com',
	keyFile: '/config/google-service-account.key',
	cryptoKey: '{{ third_parties [cluster_name].google_maps_key }}'
};

// apple push notifications

config.applePush = {
{% if bool_native [cluster_deployment.apple_push_notifications_enabled] %}

	enabled: true,
	caCertFile: ROOT + '/config/apple-ca.cert',
	certFile: ROOT + '/config/apple-push.cert',
	keyFile: ROOT + '/config/apple-push.key',
	production: {{ bool_javascript [cluster_deployment.apple_push_notifications_production] }},

{% else %}

	enabled: false,

{% endif %}
};

// facebook app configuration options
config.authentication.facebook.apps = {
        wistla: {
                appId: '{{ third_parties [cluster_name].facebookWistlaAppId }}',
                appSecret: '{{ third_parties [cluster_name].facebookWistlaAppSecret }}',
                appAccessToken: '{{ third_parties [cluster_name].facebookWistlaAppAccessToken }}'
        },
        wistlaEnterprise: {
                appId: '{{ third_parties [cluster_name].facebookWistlaEnterpriseAppId }}',
                appSecret: '{{ third_parties [cluster_name].facebookWistlaEnterpriseAppSecret }}',
                appAccessToken: '{{ third_parties [cluster_name].facebookWistlaEnterpriseAppAccessToken }}'
        },
        wistlaEnterpriseTwo: {
                appId: '{{ third_parties [cluster_name].facebookWistlaEnterpriseTwoAppId }}',
                appSecret: '{{ third_parties [cluster_name].facebookWistlaEnterpriseTwoAppSecret }}',
                appAccessToken: '{{ third_parties [cluster_name].facebookWistlaEnterpriseTwoAppAccessToken }}'
        }
};

{% if bool_native [cluster_deployment.emails_enabled] %}

// Enable email sends.
config.sendEmails = true;

{% endif %}

module.exports = config;

// ex: noet ts=4 filetype=javascript
