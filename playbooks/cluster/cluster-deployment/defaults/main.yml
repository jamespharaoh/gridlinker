---

cluster_deployment: "{{ deployments [cluster_deployment_name] }}"

cluster_deployment_home: "/data/{{ cluster_deployment_name }}"

cluster_deployment_alias: "{{
  deployments [cluster_deployment.alias]
  if cluster_deployment.type == 'alias'
  else cluster_deployment
}}"

cluster_deployment_type: "{{ cluster_deployment_types [cluster_deployment.type] }}"

cluster_deployment_checkouts: "{{ cluster_deployment_type.checkouts }}"
cluster_deployment_config_directories: "{{ cluster_deployment_type.config_directories }}"
cluster_deployment_config_templates: "{{ cluster_deployment_type.config_templates }}"
cluster_deployment_config_files: "{{ cluster_deployment_type.config_files }}"
cluster_deployment_config_links: "{{ cluster_deployment_type.config_links }}"
cluster_deployment_shared_directories: "{{ cluster_deployment_type.shared_directories }}"
cluster_deployment_override_templates: "{{ cluster_deployment_type.override_templates }}"

cluster_deployment_types:

  shared:

    checkouts:

      - name: "wistla-devops"
        branch: "master"

      - name: "wistla-scripts"
        branch: "master"

    config_directories:

      - "mongo"
      - "rabbit"

    config_templates:

      - template: "cluster-deployment-wistla-devops-config"
        target: "wistla-devops/config"

      - template: "cluster-deployment-wistla-devops-accounts"
        target: "wistla-devops/accounts"

      - template: "cluster-deployment-wistla-rabbit-erlang-cookie"
        target: "config/rabbit/erlang-cookie"
        owner: "rabbitmq"
        group: "root"
        mode: "0400"

    config_files: []
    config_links: []
    shared_directories: []
    override_templates: []

  alias:

    checkouts:

      - name: "content-browser"
        branch: "master"

      - name: "content-common"
        branch: "master"

      - name: "content-iOS"
        branch: "master"

      - name: "content-api"
        branch: "master"

      - name: "content-web"
        branch: "master"

      - name: "wistla-admin"
        branch: "master"
        build_steps:

          - "npm install"
          - "jspm install -y"
          - "./build.sh"

      - name: "wistla-analytics"
        branch: "master"
        build_steps:

          - "npm install"

      - name: "wistla-api"
        branch: "master"
        project_links:

          - link: "node_modules/wistla-analytics"
            target: "../../wistla-analytics"

        build_steps:

          - "npm install"

      - name: "wistla-browser"
        branch: "master"
        project_links:

          - link: "node_modules/wistla-analytics"
            target: "../../wistla-analytics"

        build_steps:

          - "npm install"

      - name: "wistla-devops"
        branch: "master"

      - name: "wistla-scripts"
        branch: "master"

      - name: "wistla-web"
        branch: "master"
        build_steps:

          - "npm install"

      - name: "wistla-test-images"
        branch: "master"

    config_directories:

      - "api"
      - "browser"
      - "load"
      - "web"

    config_files:

      - source: "security/test/google-service-account.key"
        target: "config/api/google-service-account.key"
        mode: "0600"

      - source: "security/apple/push-notifications/ca.cert"
        target: "config/api/apple-ca.cert"
        mode: "0644"

      - source: "security/apple/push-notifications/{{ cluster_deployment.apple_push_notifications_name | default ('none') }}.cert"
        target: "config/api/apple-push.cert"
        mode: "0644"

      - source: "security/apple/push-notifications/{{ cluster_deployment.apple_push_notifications_name | default ('none') }}.key"
        target: "config/api/apple-push.key"
        mode: "0600"

    config_links:

      - source: "../../config/api/config.local.js"
        target: "wistla-api/config/config.local.js"

      - source: "../../config/api/config.overrides.js"
        target: "wistla-api/config/config.overrides.js"

      - source: "../../config/browser/config.local.js"
        target: "wistla-browser/config/config.local.js"

      - source: "../../config/browser/config.overrides.js"
        target: "wistla-browser/config/config.overrides.js"

      - source: "../../config/web/config.local.js"
        target: "wistla-web/config/config.local.js"

      - source: "../../config/web/config.overrides.js"
        target: "wistla-web/config/config.overrides.js"

    config_templates:

      # api

      - template: "cluster-deployment-wistla-api-config"
        target: "config/api/config.local.js"

      - template: "cluster-deployment-wistla-api-environment"
        target: "config/api/environment"

      # browser

      - template: "cluster-deployment-wistla-browser-config"
        target: "config/browser/config.local.js"

      - template: "cluster-deployment-wistla-browser-environment"
        target: "config/browser/environment"

      # devops

      - template: "cluster-deployment-wistla-devops-config"
        target: "wistla-devops/config/overrides.yml"

      - template: "cluster-deployment-wistla-devops-accounts"
        target: "wistla-devops/accounts"

      # load

      - template: "cluster-deployment-wistla-load-nginx-config"
        target: "config/load/nginx-config"

      - template: "cluster-deployment-wistla-admin-config"
        target: "config/load/wistla-admin-config.local.js"

      # web

      - template: "cluster-deployment-wistla-web-config"
        target: "config/web/config.local.js"

      - template: "cluster-deployment-wistla-web-environment"
        target: "config/web/environment"

    shared_directories: []

    override_templates:

      - template: "cluster-deployment-wistla-api-overrides"
        target: "config/api/config.overrides.js"

      - template: "cluster-deployment-wistla-browser-overrides"
        target: "config/browser/config.overrides.js"

      - template: "cluster-deployment-wistla-web-overrides"
        target: "config/web/config.overrides.js"

  simple:

    checkouts:

      - name: "content-api"
        branch: "master"

      - name: "content-browser"
        branch: "master"

      - name: "content-common"
        branch: "master"

      - name: "content-iOS"
        branch: "master"

      - name: "content-web"
        branch: "master"

      - name: "wistla-admin"
        branch: "master"
        build_steps:

          - "npm install"
          - "jspm install -y"
          - "./build.sh"

      - name: "wistla-analytics"
        branch: "master"
        build_steps:

          - "npm install"

      - name: "wistla-api"
        branch: "master"
        project_links:

          - link: "node_modules/wistla-analytics"
            target: "../../wistla-analytics"

        build_steps:

          - "npm install"

      - name: "wistla-browser"
        branch: "master"
        project_links:

          - link: "node_modules/wistla-analytics"
            target: "../../wistla-analytics"

        build_steps:

          - "npm install"

      - name: "wistla-devops"
        branch: "master"

      - name: "wistla-scripts"
        branch: "master"

      - name: "wistla-web"
        branch: "master"
        build_steps:

          - "npm install"

      - name: "wistla-test-images"
        branch: "master"

    config_directories:

      - "api"
      - "browser"
      - "load"
      - "mongo"
      - "rabbit"
      - "web"

    config_files:

      - source: "security/test/google-service-account.key"
        target: "config/api/google-service-account.key"
        mode: "0600"

      - source: "security/apple/push-notifications/ca.cert"
        target: "config/api/apple-ca.cert"
        mode: "0644"

      - source: "security/apple/push-notifications/{{ cluster_deployment.apple_push_notifications_name | default ('none') }}.cert"
        target: "config/api/apple-push.cert"
        mode: "0644"

      - source: "security/apple/push-notifications/{{ cluster_deployment.apple_push_notifications_name | default ('none') }}.key"
        target: "config/api/apple-push.key"
        mode: "0600"

    config_templates:

      # admin

      - template: "cluster-deployment-wistla-admin-config"
        target: "config/load/wistla-admin-config.local.js"

      # api

      - template: "cluster-deployment-wistla-api-config"
        target: "config/api/config.local.js"

      - template: "cluster-deployment-wistla-api-environment"
        target: "config/api/environment"

      # browser

      - template: "cluster-deployment-wistla-browser-config"
        target: "config/browser/config.local.js"

      - template: "cluster-deployment-wistla-browser-environment"
        target: "config/browser/environment"

      # devops

      - template: "cluster-deployment-wistla-devops-accounts"
        target: "wistla-devops/accounts"

      - template: "cluster-deployment-wistla-devops-config"
        target: "wistla-devops/config"

      # load

      - template: "cluster-deployment-wistla-load-nginx-config"
        target: "config/load/nginx-config"

      # rabbit

      - template: "cluster-deployment-wistla-rabbit-erlang-cookie"
        target: "config/rabbit/erlang-cookie"
        owner: "rabbitmq"
        group: "root"
        mode: "0400"

      # web

      - template: "cluster-deployment-wistla-web-config"
        target: "config/web/config.local.js"

      - template: "cluster-deployment-wistla-web-environment"
        target: "config/web/environment"

    config_links:

      - source: "../../config/api/config.local.js"
        target: "wistla-api/config/config.local.js"

      - source: "../../config/api/config.overrides.js"
        target: "wistla-api/config/config.overrides.js"

      - source: "../../config/browser/config.local.js"
        target: "wistla-browser/config/config.local.js"

      - source: "../../config/browser/config.overrides.js"
        target: "wistla-browser/config/config.overrides.js"

      - source: "../../config/web/config.local.js"
        target: "wistla-web/config/config.local.js"

      - source: "../../config/web/config.overrides.js"
        target: "wistla-web/config/config.overrides.js"

    shared_directories:

      - "audio"
      - "cms-image"
      - "image"
      - "log"
      - "user-upload"
      - "video"

    override_templates:

      - template: "cluster-deployment-wistla-api-overrides"
        target: "config/api/config.overrides.js"

      - template: "cluster-deployment-wistla-browser-overrides"
        target: "config/browser/config.overrides.js"

      - template: "cluster-deployment-wistla-web-overrides"
        target: "config/web/config.overrides.js"

# ex: et ts=2 filetype=yaml
