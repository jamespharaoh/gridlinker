{{ ansible_warning ['#'] }}

{% set dev_deployment_name = item.key %}
{% set dev_deployment = item.value %}

upstream {{ dev_deployment_name }}-host {
	server {{ dev_deployment.bridge_network }}.0.1;
}

upstream {{ dev_deployment_name }}-load {
	server {{ dev_deployment.bridge_network }}.0.4;
	server {{ dev_deployment.bridge_network }}.1.4;
	server {{ dev_deployment.bridge_network }}.2.4;
	server {{ dev_deployment.bridge_network }}.3.4;
}

# website redirect to www

server {

	listen 80;

	server_name {{ dev_deployment.main_domain }};

	listen 443 ssl http2;

	ssl_certificate {{ [
		nginx_target,
		'/conf/ssl',
		'/',
		dev_deployment.main_domain,
		'.cert',
	] | join }};

	ssl_certificate_key {{ [
		nginx_target,
		'/conf/ssl/',
		dev_deployment.main_domain,
		'.key',
	] | join }};

	return 301 https://{{ dev_deployment.web_domain }}$request_uri;

}

# website redirect to ssl

server {

	listen 80;

	server_name {{ dev_deployment.web_domain }};

	return 301 https://{{ dev_deployment.web_domain }}$request_uri;

}

# website

server {

	listen 443 ssl http2;

	ssl_certificate {{ nginx_target }}/conf/ssl/{{ dev_deployment.main_domain }}.cert;
	ssl_certificate_key {{ nginx_target }}/conf/ssl/{{ dev_deployment.main_domain }}.key;

	server_name {{ dev_deployment.web_domain }};

	add_header Strict-Transport-Security "max-age={{ 60 * 60 * 24 * 365 }}";

{% if dev_deployment.robots_override_main | default ('no') != 'yes' %}
	location /robots.txt {
		alias {{ nginx_target }}/conf/dev-robots.txt;
	}
{% endif %}

	location / {
		proxy_pass http://{{ dev_deployment_name }}-load/;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

	location /keystone {
		auth_basic "Restricted";
		auth_basic_user_file {{ nginx_target }}/conf/htpasswd;
		proxy_pass http://{{ dev_deployment_name }}-load/keystone;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

# api

server {

	listen 80;
	listen 443 ssl http2;

	ssl_certificate {{ nginx_target }}/conf/ssl/{{ dev_deployment.api_domain }}.cert;
	ssl_certificate_key {{ nginx_target }}/conf/ssl/{{ dev_deployment.api_domain }}.key;

	server_name {{ dev_deployment.api_domain }};

	location /robots.txt {
		alias {{ nginx_target }}/conf/dev-robots.txt;
	}

	location / {
		proxy_pass http://{{ dev_deployment_name }}-load/;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

# admin redirect to ssl

server {

	listen 80;

	server_name {{ dev_deployment.admin_domain }};

	return 301 https://{{ dev_deployment.admin_domain }}$request_uri;

}

# admin

server {

	listen 443 ssl http2;

	server_name {{ dev_deployment.admin_domain }};

	ssl_certificate {{ nginx_target }}/conf/ssl/{{ dev_deployment.admin_domain }}.cert;
	ssl_certificate_key {{ nginx_target }}/conf/ssl/{{ dev_deployment.admin_domain }}.key;

	location /robots.txt {
		alias {{ nginx_target }}/conf/dev-robots.txt;
	}

	location / {
		proxy_pass http://{{ dev_deployment_name }}-load/;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

# short

server {

	listen 80;

	server_name {{ dev_deployment.short_domain }};

	return 301 https://{{ dev_deployment.short_domain }}$request_uri;

}

server {

	listen 443 ssl http2;

	ssl_certificate {{ nginx_target }}/conf/ssl/{{ dev_deployment.short_domain }}.cert;
	ssl_certificate_key {{ nginx_target }}/conf/ssl/{{ dev_deployment.short_domain }}.key;

	server_name {{ dev_deployment.short_domain }};

{% if dev_deployment.robots_override_short | default ('no') != 'yes' %}
	location /robots.txt {
		alias {{ nginx_target }}/conf/dev-robots.txt;
	}
{% endif %}

	location / {
		proxy_pass http://{{ dev_deployment_name }}-load/;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

{% if 'test_domain' in dev_deployment %}

# test

server {

	listen 80;
	listen 443 ssl http2;

	server_name {{ dev_deployment.test_domain }};

	ssl_certificate {{ nginx_target }}/conf/ssl/{{ dev_deployment.test_domain }}.cert;
	ssl_certificate_key {{ nginx_target }}/conf/ssl/{{ dev_deployment.test_domain }}.key;

	location /robots.txt {
		alias {{ nginx_target }}/conf/dev-robots.txt;
	}

	location / {
		proxy_pass http://{{ dev_deployment_name }}-host/;
		proxy_set_header Host $host;
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

{% endif %}

# assets

server {

	listen 80;
	listen 443 ssl http2;

	server_name {{ dev_deployment.assets_domain }};

	ssl_certificate {{ nginx_target }}/conf/ssl/{{ dev_deployment.assets_domain }}.cert;
	ssl_certificate_key {{ nginx_target }}/conf/ssl/{{ dev_deployment.assets_domain }}.key;

{% if dev_deployment.robots_override_assets | default ('no') != 'yes' %}
	location /robots.txt {
		alias {{ nginx_target }}/conf/dev-robots.txt;
	}
{% endif %}

	location / {
		proxy_pass http://{{ dev_deployment_name }}-load/;
		proxy_set_header Host {{ dev_deployment.assets_domain }};
		proxy_set_header X-Wistla-Entry-Region {{ region_code }};
	}

}

#	# assets redirect to ssl
#
#	server {
#
#
#		server_name {{ dev_deployment.assets_domain }};
#
#		return 301 https://{{ dev_deployment.assets_domain }}$request_uri;
#
#	}
