---

- name: "create security groups"
  with_items: "amazon_security_groups"
  register: "create_group"
  action:

    module: "ec2_group"
    name: "{{ cluster_name }}-{{ item.name }}"
    description: "Security group {{ cluster_name }}-{{ item.name }}"

    vpc_id: "{{ vpc_id }}"
    purge_rules: "no"

    region: "{{ amazon_region_name }}"
    aws_access_key: "{{ amazon_account.access_key }}"
    aws_secret_key: "{{ amazon_account.secret_key }}"

- update_resource:

    security_group_id_admin: "{{ create_group.results.0.group_id }}"
    security_group_id_app: "{{ create_group.results.1.group_id }}"
    security_group_id_balancer: "{{ create_group.results.2.group_id }}"
    security_group_id_data: "{{ create_group.results.3.group_id }}"
    security_group_id_jenkins: "{{ create_group.results.4.group_id }}"

- name: "update security group"
  with_items: "amazon_security_groups"
  action:

    module: "ec2_group"
    name: "{{ cluster_name }}-{{ item.name }}"
    description: "Security group {{ cluster_name }}-{{ item.name }}"

    vpc_id: "{{ vpc_id }}"
    rules: "{{ item.rules }}"

    region: "{{ amazon_region_name }}"
    aws_access_key: "{{ amazon_account.access_key }}"
    aws_secret_key: "{{ amazon_account.secret_key }}"

# ex: et ts=2 filetype=yaml
