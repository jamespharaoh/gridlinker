---

- name: "create public route"
  with_items:

    - "{{ cluster_network ['routes_app_' + instance_zone] | default ('') }}"
    - "{{ cluster_network ['routes_data_' + instance_zone] | default ('') }}"
    - "{{ cluster_network ['routes_jenkins_' + instance_zone] | default ('') }}"

  delegate_to: "localhost"
  environment:

    AWS_DEFAULT_REGION: "{{ amazon_region_name }}"

    AWS_ACCESS_KEY_ID: "{{ amazon_credentials [amazon_account_name].access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ amazon_credentials [amazon_account_name].secret_key }}"
    AWS_SESSION_TOKEN: "{{ amazon_credentials [amazon_account_name].session_token }}"

  args:

    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    set;

    if test "{{ item }}"; then

      aws ec2 delete-route
        --route-table-id "{{ item }}"
        --destination-cidr-block "0.0.0.0/0"
      || true;

      aws ec2 create-route
        --route-table-id "{{ item }}"
        --destination-cidr-block "0.0.0.0/0"
        --instance-id "{{ instance_id }}";

    fi;

- name: "create vpn route"
  with_items:

    - "{{ cluster_network.routes_admin_a | default ('') }}"
    - "{{ cluster_network.routes_admin_b | default ('') }}"
    - "{{ cluster_network.routes_admin_c | default ('') }}"
    - "{{ cluster_network.routes_app_a | default ('') }}"
    - "{{ cluster_network.routes_app_b | default ('') }}"
    - "{{ cluster_network.routes_app_c | default ('') }}"
    - "{{ cluster_network.routes_data_a | default ('') }}"
    - "{{ cluster_network.routes_data_b | default ('') }}"
    - "{{ cluster_network.routes_data_c | default ('') }}"
    - "{{ cluster_network.routes_jenkins_a | default ('') }}"
    - "{{ cluster_network.routes_jenkins_b | default ('') }}"
    - "{{ cluster_network.routes_jenkins_c | default ('') }}"

  delegate_to: "localhost"
  environment:

    AWS_DEFAULT_REGION: "{{ amazon_region_name }}"

    AWS_ACCESS_KEY_ID: "{{ amazon_credentials [amazon_account_name].access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ amazon_credentials [amazon_account_name].secret_key }}"
    AWS_SESSION_TOKEN: "{{ amazon_credentials [amazon_account_name].session_token }}"

  args:

    executable: "/bin/bash"

  shell:

    set -euf -o pipefail;

    if test "{{ item }}"; then

      aws ec2 delete-route
        --route-table-id "{{ item }}"
        --destination-cidr-block "{{ vpn_network }}.0/24"
      || true;

      aws ec2 create-route
        --route-table-id "{{ item }}"
        --destination-cidr-block "{{ vpn_network }}.0/24"
        --instance-id "{{ instance_id }}";

    fi;

# ex: et ts=2 filetype=yaml
