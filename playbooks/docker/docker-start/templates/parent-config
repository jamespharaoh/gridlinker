---

{% set cluster = hostvars ['cluster/' + identity_cluster] %}

cluster_name: "{{ identity_cluster }}"
cluster: "{{ '{{' }} clusters [cluster_name] {{ '}}' }}"

parent_address: "{{ parent.private.address }}"

{% set database_master = hostvars ['host/' + cluster.cluster.database_master] %}
{% set database_master_parent = hostvars ['host/' + database_master.identity.parent] %}

database_master_name: "dating"
database_master_address: "{{ database_master_parent.private_address }}"
database_master_port: "{{ cluster.ports.database }}"
database_master_user: "jimmy"
database_master_password: "topsecret"

{% set database_slaves_string %}
{% for database_name in groups.database %}
{% set database = hostvars [database_name] %}
{% set database_parent = hostvars ['host/' + database.identity_parent] %}
{% if database.identity_cluster == identity_cluster %}
{% if database.identity_name != cluster.cluster_database_master %}
  - name: "dating"
    address: "{{ database_master_parent.private_address }}"
    port: "{{ cluster.ports_database }}"
    user: "jimmy"
    password: "topsecret"
{% endif %}
{% endif %}
{% endfor %}
{% endset %}
{% if database_slaves_string %}
database_slaves:
{{ database_slaves_string }}
{% else %}
database_slaves: []
{% endif %}


{% if inventory_hostname in groups.database | default ([]) %}
{% if identity_name == cluster.cluster.database_master %}
database_mode: "master"
{% else %}
database_mode: "slave"
{% endif %}
{% endif %}

memcache_nodes:
{% for memcache_name in groups.memcache %}
{% set memcache = hostvars [memcache_name] %}
{% set memcache_parent = hostvars ['host/' + memcache.identity.parent] %}
{% if memcache.identity.cluster == identity.cluster %}
  - name: "{{ memcache_parent.private.address }}"
    port: "{{ cluster.ports.memcache }}"
{% endif %}
{% endfor %}

vm_addresses:

{% for vm_name in []
  | union (groups ['rocket-hz-vm'] | default ([]))
  | union (groups ['vagrant-devbox'] | default ([]))
%}
  - "{{ hostvars [vm_name].private.address }}"
{% endfor %}

{% if inventory_hostname in groups.database | default ([]) %}
{% if identity_cluster in [ 'staging', 'production' ] %}
postgresql_shared_buffers: "8GB"
postgresql_temp_buffers: "32MB"
postgresql_work_mem: "95MB"
postgresql_maintenance_work_mem: "2GB"
postgresql_wal_buffers: "16MB"
postgresql_effective_cache_size: "22GB"
{% else %}
postgresql_shared_buffers: "128MB"
postgresql_temp_buffers: "32MB"
postgresql_work_mem: "16MB"
postgresql_maintenance_work_mem: "256MB"
postgresql_wal_buffers: "16MB"
postgresql_effective_cache_size: "256MB"
{% endif %}
{% endif %}

# ex: et ts=2 filetype=yaml
