---

- name: "install openvpn ca cert"
  notify: "restart openvpn"
  sudo: "yes"
  action:

    module: "copy"
    dest: "/etc/openvpn/wistla-ca.cert"
    src: "{{ HOME }}/security/wistla-ca.cert"

- name: "install wistla-dh.pem"
  notify: "restart openvpn"
  sudo: "yes"
  action:

    module: "copy"
    dest: "/etc/openvpn/wistla-dh.pem"
    src: "{{ HOME }}/security/wistla-dh.pem"

- name: "install openvpn server cert"
  notify: "restart openvpn"
  sudo: "yes"
  action:

    module: "copy"
    dest: "/etc/openvpn/wistla-{{ cluster_name }}-vpn.cert"
    src: "{{ HOME }}/security/vpn-server/{{ cluster_name }}.cert"

- name: "install openvpn server key"
  notify: "restart openvpn"
  sudo: "yes"
  action:

    module: "copy"
    dest: "/etc/openvpn/wistla-{{ cluster_name }}-vpn.key"
    src: "{{ HOME }}/security/vpn-server/{{ cluster_name }}.key"

    mode: "0600"

- name: "create openvpn config"
  notify: "restart openvpn"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/openvpn/wistla-{{ cluster_name }}-vpn.conf"
    src: "openvpn-config"

- name: "create openvpn client config dir"
  sudo: "yes"
  action:

    module: "file"
    name: "/etc/openvpn/clients"
    state: "directory"

- name: "create openvpn client configs"
  with_items: "vpn_clients"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/openvpn/clients/{{ item.name }}"
    src: "openvpn-client-config"

- name: "create openvpn client connect script"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/openvpn/client-connect-script"
    src: "openvpn-client-connect-script"

    mode: "0755"

- name: "create openvpn client disconnect script"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/openvpn/client-disconnect-script"
    src: "openvpn-client-disconnect-script"

    mode: "0755"

- meta: "flush_handlers"

# ex: et ts=2 filetype=yaml
