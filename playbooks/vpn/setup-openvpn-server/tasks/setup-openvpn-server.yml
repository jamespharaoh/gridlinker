---

- name: "issue vpn server certificate"
  when: "vpn_server_certificate | default ('') == ''"
  register: "vpn_server_certificate_result"
  action:

    module: "certificate_authority_issue"
    authority: "ops-vpn"
    common_name: "{{ inventory_hostname }}"
    usage: "mixed"
    alt_dns:
      - "{{ inventory_hostname }}"
      - "{{ inventory_hostname }}.{{ cluster.local_domain }}"
      - "vpn.{{ cluster.local_domain }}"

- name: "store vpn server certificate"
  when: "vpn_server_certificate_result | changed"
  update_resource:

    vpn_server.certificate: "{{ vpn_server_certificate_result.certificate }}"
    vpn_server.private_key: "{{ vpn_server_certificate_result.private_key }}"

- name: "install openvpn ca cert"
  notify: "restart openvpn"
  sudo: "yes"
  action:

    module: "copy"
    dest: "/etc/openvpn/wistla-ca.cert"
    content: "{{ lookup ('etcd', '/authority/ops-vpn/certificate') }}"

- name: "install wistla-dh.pem"
  notify: "restart openvpn"
  sudo: "yes"
  action:

    module: "copy"
    dest: "/etc/openvpn/wistla-dh.pem"
    src: "{{ HOME }}/security/wistla-dh.pem"

- name: "install openvpn server cert"
  notify: "restart openvpn"
  sudo: "yes"
  action:

    module: "copy"
    dest: "/etc/openvpn/wistla-{{ cluster_name }}-vpn.cert"
    content: "{{ lookup ('etcd', vpn_server_certificate) }}"

- name: "install openvpn server key"
  notify: "restart openvpn"
  sudo: "yes"
  action:

    module: "copy"
    dest: "/etc/openvpn/wistla-{{ cluster_name }}-vpn.key"
    content: "{{ lookup ('etcd', vpn_server_private_key) }}"

    mode: "0600"

- name: "create openvpn config"
  notify: "restart openvpn"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/openvpn/wistla-{{ cluster_name }}-vpn.conf"
    src: "openvpn-config"

- name: "create openvpn client config dir"
  sudo: "yes"
  action:

    module: "file"
    name: "/etc/openvpn/clients"
    state: "directory"

- name: "create openvpn client configs"
  with_items: "{{ vpn_clients }}"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/openvpn/clients/{{ item.name }}"
    src: "openvpn-client-config"

- name: "create openvpn admin client configs"
  with_items: "{{ groups ['cluster-admin'] }}"
  sudo: "yes"
  action:

    module: "template"
    dest: "/etc/openvpn/clients/{{ item }}"
    src: "openvpn-admin-client-config"

- name: "create openvpn client connect script"
  sudo: "yes"
  tags: "aaa"
  action:

    module: "template"
    dest: "/etc/openvpn/client-connect-script"
    src: "openvpn-client-connect-script"

    mode: "0755"

- name: "create openvpn client disconnect script"
  sudo: "yes"
  tags: "aaa"
  action:

    module: "template"
    dest: "/etc/openvpn/client-disconnect-script"
    src: "openvpn-client-disconnect-script"

    mode: "0755"

- name: "create openvpn cluster configs"
  with_nested:

    - "{{ cluster.vpn_upstream_clusters }}"
    - [ "a", "b", "c" ]

  notify: "restart openvpn"
  sudo: "yes"
  tags: "aaa"
  action:

    module: "template"
    dest: "{{ [
      '/etc/openvpn/wistla-',
      item.0,
      '-admin-',
      item.1,
      '.conf',
    ] | join }}"
    src: "openvpn-cluster-config"

- meta: "flush_handlers"

# ex: et ts=2 filetype=yaml
