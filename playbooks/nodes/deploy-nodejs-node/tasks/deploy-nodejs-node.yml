---

- name: "deploy projects"
  delegate_to: "localhost"
  sudo: "yes"
  register: "deploy_output"
  changed_when: "deploy_output.stdout != ''"
  with_items: "node_deploy_projects"
  tags: "quick"
  args:
    executable: "/bin/bash"
  shell:

    set -euf -o pipefail;

    rsync
      --archive
      --delete
      --itemize-changes
      {{ deployment_home }}/{{ item.name }}/
      /var/lib/lxc/{{ inventory_hostname }}/rootfs/home/ubuntu/{{ item.name }}/
      --exclude /.git
      --exclude /node_modules
      {{
        item.excludes
        | default ([])
        | prepend_list ('--exclude ')
        | join (' ')
      }};

- name: "deploy projects node modules"
  delegate_to: "localhost"
  sudo: "yes"
  register: "deploy_output"
  changed_when: "deploy_output.stdout != ''"
  with_items: "node_deploy_projects"
  args:
    executable: "/bin/bash"
  shell:

    set -euf -o pipefail;

    rsync
      --archive
      --delete
      --itemize-changes
      {{ deployment_home }}/{{ item.name }}/node_modules/
      /var/lib/lxc/{{ inventory_hostname }}/rootfs/home/ubuntu/{{ item.name }}/node_modules/;

- name: "create init config"
  action:
    module: "template"
    src: "{{ item.1.template }}"
    dest: "/etc/init/{{ item.0.name }}{{ item.1.target_suffix }}.conf"
  sudo: "yes"
  with_nested:

    - "node_deploy_projects"

    - - template: "node-nodejs-upstart"
        target_suffix: ""

      - template: "node-nodejs-instance-upstart"
        target_suffix: "-instance"

- name: "create links to config"
  action:

    module: "file"
    path: "/home/ubuntu/{{ item.outer.name }}/config/{{ item.configs }}"
    state: "link"
    src: "/config/{{ item.configs }}"
    force: "yes"

  with_items: "{{
    node_deploy_projects | flatten_hash ('configs')
  }}"

- name: "create other links"
  action:

    module: "file"
    path: "/home/ubuntu/{{ item.outer.name }}/{{ item.other_links.link }}"
    state: "link"
    src: "{{ item.other_links.target }}"
    force: "yes"

  with_items: "{{
    node_deploy_projects | flatten_hash ('other_links')
  }}"

# ex: et ts=2 filetype=yaml
