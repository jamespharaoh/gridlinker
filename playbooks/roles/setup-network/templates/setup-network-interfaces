# loopback

auto lo
iface lo inet loopback

	# firewall rules

	up ! test -x /etc/network/firewall-rules || /etc/network/firewall-rules
	up ! test -x /etc/network/bridge-rules || /etc/network/bridge-rules

# public bridge

auto brpub0
iface brpub0 inet static

	address {{ public.address }}
	netmask {{ public.netmask }}
	broadcast {{ public.broadcast }}
	gateway {{ public.gateway }}

	bridge_ports eth0
	bridge_stp off
	bridge_maxwait 0
	bridge_fd 0

	# firewall rules

	up ! test -x /etc/network/firewall-rules || /etc/network/firewall-rules
	up ! test -x /etc/network/bridge-rules || /etc/network/bridge-rules

	# use hetzner router even for local addresses

	up route add -net {{ public.network }} netmask {{ public.netmask }} gw {{ public.gateway }} brpub0

{% if failover is defined %}
	# failover addresses

{% for failover_address in []
	| union (failover.primary | default ([]))
	| union (failover.backup | default ([]))
%}
	up ip addr add {{ failover_address }}/32 dev brpub0
{% endfor %}
{% endif %}

# private bridge

auto brprv0
iface brprv0 inet static

	address {{ private.address }}
	netmask {{ private.netmask }}
	broadcast {{ private.broadcast }}

	bridge_ports eth1
	bridge_stp off
	bridge_maxwait 0
	bridge_fd 0

	# firewall rules

	up ! test -x /etc/network/firewall-rules || /etc/network/firewall-rules
	up ! test -x /etc/network/bridge-rules || /etc/network/bridge-rules

	# vpn routing

{% for host_name in groups ['rocket-hz-host']
	if host_name != identity.name %}
{% set host = hostvars [host_name] %}
	up route add -net {{ host.openvpn.network }}.0/24 gw {{ host.private.address }} brprv0
	down route del -net {{ host.openvpn.network }}.0/24 gw {{ host.private.address }} brprv0
{% endfor %}

# dummy for mail

auto dummy0
iface dummy0 inet static

	pre-up modprobe dummy

	address 10.69.132.1
	netmask 255.255.255.255
