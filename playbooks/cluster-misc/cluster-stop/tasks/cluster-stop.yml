---

- when: "
    (
      amazon_instance_state == 'stopped'
    ) and (
      cluster_name != 'production'
      or cluster_production_override == inventory_hostname
    )
  "
  block:

    - name: "remove instance from load balancer"
      when: "load_balancer_name is defined"
      local_action:

        module: "ec2_elb"
        instance_id: "{{ instance_id }}"
        ec2_elbs: "{{ load_balancer_name }}"
        state: "absent"

        region: "{{ amazon_region_name }}"

        aws_access_key: "{{ amazon_credentials [amazon_account_name].access_key }}"
        aws_secret_key: "{{ amazon_credentials [amazon_account_name].secret_key }}"
        security_token: "{{ amazon_credentials [amazon_account_name].session_token }}"

    - name: "stop amazon instance"
      local_action:

        module: "ec2"
        instance_ids: "{{ instance_id }}"
        state: "stopped"

        region: "{{ amazon_region_name }}"

        aws_access_key: "{{ amazon_credentials [amazon_account_name].access_key }}"
        aws_secret_key: "{{ amazon_credentials [amazon_account_name].secret_key }}"
        security_token: "{{ amazon_credentials [amazon_account_name].session_token }}"

    - name: "set amazon_instance_type_running to ''"
      when: "
        amazon_instance_state == 'running'
        and amazon_instance_type_running != ''
        and amazon_instance_type != amazon_instance_type_running
      "
      update_resource:

        amazon_instance_type_running: ""

# ex: et ts=2 filetype=yaml
