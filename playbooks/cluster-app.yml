---

- include: "cluster-app/cluster-app-create.yml"
- include: "cluster-app/cluster-app-system.yml"
- include: "cluster-app/cluster-app-setup-dns.yml"

- hosts: "cluster-app"
  roles:

    - "system-apt-setup"
    - "setup-common-users"
    - "setup-hostname"
    - "setup-system"
    - "setup-logging"
    - "cluster-ssh"
    - "system-packages-install"
    - "install-kernel"
    - "install-postfix"
    - "cluster-volumes"
    - "cluster-user"

- include: "cluster-app/cluster-app-heka.yml"
- include: "cluster-app/cluster-app-python.yml"

- hosts: "cluster-app"
  roles:

    - "cluster-app-network"

    - "install-mongodb"
    - "install-tools"

    - "nodejs-install"
    - "nodejs-packages-install"

    - role: "nodejs-install"
      when: "
        nodejs_version_legacy != ''
        and nodejs_version != nodejs_version_legacy
      "
      nodejs_version: "{{ nodejs_version_legacy }}"

    - role: "nodejs-packages-install"
      when: "
        nodejs_version_legacy != ''
        and nodejs_version != nodejs_version_legacy
      "
      nodejs_version: "{{ nodejs_version_legacy }}"
      nodejs_packages: "{{ nodejs_packages_legacy }}"

    - "nodejs-stubs"

- include: "cluster-app/cluster-app-nginx.yml"

- hosts: "cluster-app"
  roles:

    - "cluster-app-lxc"
    - "cluster-app-cron"

- include: "cluster-app/cluster-app-rzbackup.yml"
- include: "cluster-app/cluster-app-activate.yml"

# ex: et ts=2 filetype=yaml
