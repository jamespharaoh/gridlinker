---

THIS IS OBSOLETE!

- name: "start master"
  hosts: "database_master"
  tags: "backup-init"
  roles:
    - role: "start-database-master"
      state: "running"

- name: "stop slaves"
  hosts: "database_slave"
  tags: "backup-init"
  roles:
    - role: "start-database-slave"
      state: "stopped"

- name: "start backup on master"
  hosts: "database_master"
  tags: "backup-start"
  tasks:

    - name: "start backup"
      command: >
        psql
        --host localhost
        --port {{ database.master.port }}
        --command "select pg_start_backup ('initial_backup');"
        --no-password
      environment:
        PGUSER: "postgres"
        PGPASSWORD: "topsecret"

- name: "copy to slaves"
  hosts: "database_slave"
  tags: "backup-copy"
  tasks:

    - name: "create directory"
      action:
        module: "file"
        path: "{{ data_dir }}/{{ cluster_name }}-database-slave/postgresql"
        state: "directory"
      sudo: "yes"

    - name: "copy to slaves"
      command: >
        rsync
        --checksum
        --archive
        --inplace
        --delete
        --exclude *pg_xlog*
        {{ database.master.hostname }}:{{ data_dir }}/{{ cluster_name }}-database-master/postgresql/
        {{ data_dir }}/{{ cluster_name }}-database-slave/postgresql/
      sudo: "yes"

- name: "stop backup on master"
  hosts: "database_master"
  tags: "backup-stop"
  tasks:

    - name: "stop backup on master"
      command: >
        psql
        --host localhost
        --port {{ database.master.port }}
        --command "select pg_stop_backup ();"
        --no-password
      environment:
        PGUSER: "postgres"
        PGPASSWORD: "topsecret"

- name: "configure recovery on slaves"
  hosts: "database_slave"
  tags: "backup-recover"
  tasks:

    - name: "create recovery config"
      action:
        module: "template"
        src: "templates/recovery.conf.j2"
        dest: "{{ data_dir }}/{{ cluster_name }}-database-slave/postgresql/recovery.conf"
      sudo: "yes"

- name: "start slaves"
  hosts: "database_slave"
  tags: "backup-recover"
  roles:
    - role: "start-database-slave"
      state: "running"
