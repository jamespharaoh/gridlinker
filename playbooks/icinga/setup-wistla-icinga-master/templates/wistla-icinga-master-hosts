{{ ansible_warning ['//'] }}

{% for other_cluster_name, other_cluster in clusters.items () %}

# ==================== cluster {{ other_cluster_name }}

object HostGroup "cluster-{{ other_cluster_name }}" {

	display_name = "Cluster {{ other_cluster_name }}"

	assign where host.vars.cluster == "{{ other_cluster_name }}"

}

# --------- admin instances

{% for host_name in groups ['cluster-' + other_cluster_name + '-admin'] %}
{% set host = hostvars [host_name] %}

object Host "{{ host_name }}" {

	import "generic-host"

	address = "{{ host_name }}"

	command_endpoint = "wistla-{{ other_cluster_name }}-admin-a"

	vars.endpoint = "{{ host_name }}"
	vars.cluster = "{{ other_cluster_name }}"
	vars.stature = "cluster"
	vars.type = "cluster-admin"

	vars.disks ["disk system"] = {
		disk_partitions = "/"
	}

}

{% endfor %}

{% if 'cluster-' + other_cluster_name + '-app' in groups %}

# ---------- app instances

{% for host_name in groups ['cluster-' + other_cluster_name + '-app'] %}
{% set host = hostvars [host_name] %}

object Host "{{ host_name }}" {

	import "generic-host"

	address = "{{ host_name }}"

	command_endpoint = "wistla-{{ other_cluster_name }}-admin-a"

	vars.endpoint = "{{ host_name }}"
	vars.cluster = "{{ other_cluster_name }}"
	vars.stature = "cluster"
	vars.type = "cluster-app"

	vars.disks ["disk system"] = {
		disk_partitions = "/"
	}

	vars.disks ["disk containers"] = {
		disk_partitions = "/var/lib/lxc"
	}

	vars.disks ["disk data"] = {
		disk_partitions = "/data"
	}

	vars.procs_warning = {{ [
		200,
		other_cluster.deployment_names | length * 100,
	] | sum }}

	vars.procs_critical = {{ [
		400,
		other_cluster.deployment_names | length * 100,
	] | sum }}

}

{% endfor %}
{% endif %}

{% if 'cluster-' + other_cluster_name + '-data' in groups %}

# ---------- data instances

{% for host_name in groups ['cluster-' + other_cluster_name + '-data'] %}
{% set host = hostvars [host_name] %}

object Host "{{ host_name }}" {

	import "generic-host"

	address = "{{ host_name }}"

	command_endpoint = "wistla-{{ other_cluster_name }}-admin-a"

	vars.endpoint = "{{ host_name }}"
	vars.cluster = "{{ other_cluster_name }}"
	vars.stature = "cluster"
	vars.type = "cluster-data"

	vars.disks ["disk system"] = {
		disk_partitions = "/"
	}

	vars.disks ["disk containers"] = {
		disk_partitions = "/var/lib/lxc"
	}

	vars.disks ["disk data"] = {
		disk_partitions = "/data"
	}

}

{% endfor %}
{% endif %}

{% if 'cluster-' + other_cluster_name + '-jenkins' in groups %}

# ---------- jenkins instances

{% for host_name in groups ['cluster-' + other_cluster_name + '-jenkins'] %}
{% set host = hostvars [host_name] %}

object Host "{{ host_name }}" {

	import "generic-host"

	address = "{{ host_name }}"

	command_endpoint = "wistla-{{ other_cluster_name }}-admin-a"

	vars.endpoint = "{{ host_name }}"
	vars.cluster = "{{ other_cluster_name }}"
	vars.stature = "cluster"
	vars.type = "cluster-jenkins"

	vars.disks ["disk system"] = {
		disk_partitions = "/"
	}

	vars.disks ["disk containers"] = {
		disk_partitions = "/var/lib/lxc"
	}

	vars.disks ["disk data"] = {
		disk_partitions = "/data"
	}

	vars.procs_warning = {{ [
		200,
		host.jenkins_deployment_names | length * 100,
	] | sum }}

	vars.procs_critical = {{ [
		400,
		host.jenkins_deployment_names | length * 100,
	] | sum }}

}

{% endfor %}
{% endif %}

{% endfor %}

{% macro deployment_nodes (
	node_type,
	other_deployment_name,
	parent_instance_type) %}

{%	set other_deployment = deployments [other_deployment_name] %}
{%	set other_cluster_name = other_deployment.cluster %}
{%	set other_cluster = clusters [other_cluster_name] %}
{%	set instance_formation = other_cluster.instance_formation [parent_instance_type] %}

# --------- {{ node_type }} nodes

{%	for zone in instance_formation.zones %}
{%	for index in instance_formation.indices %}

{%		set host_name = [
			other_deployment_name,
			node_type,
			zone,
			index,
		] | join ('-') %}

{%		set parent_name = [
			'wistla',
			other_deployment.cluster,
			parent_instance_type,
			zone,
			index,
		] | join ('-') %}

object Host "{{ host_name }}" {

	import "generic-host"

	address = "{{ host_name }}"

	command_endpoint = "wistla-{{ other_deployment.cluster }}-admin-a"

	vars.parent = "{{ parent_name }}"
	vars.endpoint = "{{ parent_name }}"
	vars.deployment = "{{ other_deployment_name }}"
	vars.stature = "node"
	vars.type = "node-{{ node_type }}"

}

{%	endfor %}
{%	endfor %}

{% endmacro %}

{% for other_deployment_name, other_deployment in deployments.items () %}
{% if other_deployment.cluster in clusters
	and other_deployment.type in [ 'simple', 'shared', 'alias' ]
	and other_deployment.monitoring == 'yes' %}
{% set other_cluster = clusters [other_deployment.cluster] %}

# ==================== deployment {{ other_deployment_name }}

object HostGroup "deployment-{{ other_deployment_name }}" {

	display_name = "Deployment {{ other_deployment_name }}"

	assign where host.vars.deployment == "{{ other_deployment_name }}"

}

{%	if other_deployment.cluster == 'test' %}
{%		set app_instance_type = 'app' %}
{%		set data_instance_type = 'app' %}
{%	else %}
{%		set app_instance_type = 'app' %}
{%		set data_instance_type = 'data' %}
{%	endif %}

{%	if other_deployment.type in [ 'shared', 'simple' ] %}

{%		print deployment_nodes (
			'mongo',
			other_deployment_name,
			data_instance_type) %}

{%		print deployment_nodes (
			'rabbit',
			other_deployment_name,
			data_instance_type) %}

{%	endif %}

{%	if other_deployment.type in [ 'alias', 'simple' ] %}

{%		print deployment_nodes (
			'api',
			other_deployment_name,
			app_instance_type) %}

{%		print deployment_nodes (
			'browser',
			other_deployment_name,
			app_instance_type) %}

{%		print deployment_nodes (
			'load',
			other_deployment_name,
			app_instance_type) %}

{%		print deployment_nodes (
			'web',
			other_deployment_name,
			app_instance_type) %}

{%	endif %}

{% endif %}
{% endfor %}
